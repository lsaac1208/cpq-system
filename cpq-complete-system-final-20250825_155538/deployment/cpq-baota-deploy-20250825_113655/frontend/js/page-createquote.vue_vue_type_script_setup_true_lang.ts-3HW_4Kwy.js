var e=Object.defineProperty,a=Object.defineProperties,t=Object.getOwnPropertyDescriptors,l=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,u=Object.prototype.propertyIsEnumerable,r=(a,t,l)=>t in a?e(a,t,{enumerable:!0,configurable:!0,writable:!0,value:l}):a[t]=l,n=(e,a,t)=>new Promise((l,o)=>{var u=e=>{try{n(t.next(e))}catch(a){o(a)}},r=e=>{try{n(t.throw(e))}catch(a){o(a)}},n=e=>e.done?l(e.value):Promise.resolve(e.value).then(u,r);n((t=t.apply(e,a)).next())});import{a as d,y as i,a3 as s,E as c,g as p,h as m,z as _,i as v,I as f,$ as g,k as y,a1 as h,Y as b,j as V,u as w,b as x}from"./element-plus-DR0qywX_.js";import{r as P,d as q,z as C,b as U,aA as k,Z as j,w as S,l as $,A as N,C as O,S as I,Q as z,K as L,az as A,P as D,J as B,M as E,R as F,a8 as T,B as Q}from"./vue-BMWQU0Ry.js";import{p as R,o as J}from"./api-BHu6TLr6.js";import{d as K}from"./vendor-B3dkwCfs.js";import{s as M}from"./utils-BjNHK8wL.js";const Y=K("products",()=>{const e=P([]),a=P(null),t=P([]),l=P(!1),o=P(0),u=P(1),r=P(20),d=a=>n(void 0,null,function*(){var t,n,d;l.value=!0;try{const l=yield R.getProducts(a);return l&&"object"==typeof l?(e.value=l.products||[],o.value=(null==(t=l.pagination)?void 0:t.total)||0,u.value=(null==(n=l.pagination)?void 0:n.page)||1,r.value=(null==(d=l.pagination)?void 0:d.per_page)||20,l):(e.value=[],o.value=0,{products:[],pagination:{total:0,page:1,per_page:20}})}catch(i){throw e.value=[],o.value=0,i}finally{l.value=!1}});return{products:q(e),currentProduct:q(a),categories:q(t),loading:q(l),total:q(o),currentPage:q(u),pageSize:q(r),loadProducts:d,loadProduct:e=>n(void 0,null,function*(){l.value=!0;try{const t=yield R.getProduct(e);if(t&&t.product)return a.value=t.product,t.product;throw a.value=null,new Error("Invalid product data received")}catch(t){throw a.value=null,t}finally{l.value=!1}}),createProduct:a=>n(void 0,null,function*(){l.value=!0;try{const t=yield R.createProduct(a);if(t&&t.product)return e.value.unshift(t.product),o.value=o.value+1,t;throw new Error("Invalid product creation response")}catch(t){throw t}finally{l.value=!1}}),updateProduct:(t,o)=>n(void 0,null,function*(){var u;l.value=!0;try{const l=yield R.updateProduct(t,o),r=e.value.findIndex(e=>e.id===t);return-1!==r&&(e.value[r]=l.product),(null==(u=a.value)?void 0:u.id)===t&&(a.value=l.product),l}finally{l.value=!1}}),deleteProduct:a=>n(void 0,null,function*(){l.value=!0;try{const t=yield R.deleteProduct(a),l=e.value.findIndex(e=>e.id===a);return-1!==l&&(e.value[l].is_active=!1),t}finally{l.value=!1}}),loadCategories:()=>n(void 0,null,function*(){try{const e=yield R.getCategories();return t.value=(null==e?void 0:e.categories)||[],(null==e?void 0:e.categories)||[]}catch(e){return t.value=[],[]}}),loadAllProductsForCatalog:()=>n(void 0,null,function*(){l.value=!0;try{return(yield R.getProducts({is_active:!0,per_page:1e3})).products}finally{l.value=!1}}),clearCurrentProduct:()=>{a.value=null},getProductById:a=>e.value.find(e=>e.id===a),refreshProducts:e=>n(void 0,null,function*(){const a=e||{category:"",is_active:!0,page:u.value,per_page:r.value};return yield d(a)}),resetStore:()=>{e.value=[],a.value=null,t.value=[],o.value=0,u.value=1,r.value=20,l.value=!1}}}),Z={class:"create-quote"},G={class:"page-header"},H={class:"header-actions"},W={class:"card-header"},X={key:0,class:"empty-items"},ee={class:"product-info"},ae={class:"product-code"},te={class:"line-total"},le={key:2,class:"quote-totals"},oe={class:"totals-section"},ue={class:"total-row"},re={key:0,class:"total-row"},ne={key:1,class:"total-row"},de={class:"total-row final-total"},ie={class:"product-option"},se={class:"product-name"},ce={class:"product-price"},pe={key:0,class:"product-preview"},me={class:"dialog-footer"},_e=C({__name:"CreateQuote",setup(e){const q=k(),C=A(),R=Y(),K=P(!1),_e=P(!1),ve=P(new Date(Date.now()+2592e6)),fe=P(),ge=P(),ye=U(()=>!!q.params.id);P(null);const he=P([]),be=j({customer_name:"",customer_email:"",customer_company:"",customer_phone:"",customer_address:"",items:[],discount_percentage:0,tax_percentage:0,notes:"",terms_conditions:""}),Ve=j({product_id:0,quantity:1,unit_price:0,discount_percentage:0,notes:""}),we={customer_name:[{required:!0,message:"请输入客户名称",trigger:"blur"}],customer_email:[{required:!0,message:"请输入客户邮箱",trigger:"blur"},{type:"email",message:"请输入有效的邮箱地址",trigger:"blur"}]},xe={product_id:[{required:!0,message:"请选择产品",trigger:"change"}],quantity:[{required:!0,message:"请输入数量",trigger:"blur"}],unit_price:[{required:!0,message:"请输入单价",trigger:"blur"}]},Pe=U(()=>he.value.find(e=>e.id===Ve.product_id)),qe=U(()=>{const e=be.items.reduce((e,a)=>e+a.line_total,0),a=e*(be.discount_percentage||0)/100,t=e-a,l=t*(be.tax_percentage||0)/100;return{subtotal:e,discount_amount:a,tax_amount:l,total:t+l}});S(()=>q.query.products,e=>{if(e&&"string"==typeof e){const a=e.split(",").map(e=>parseInt(e,10));Ue(a)}},{immediate:!0}),S(ve,e=>{e&&(be.valid_until=e.toISOString().split("T")[0])});const Ce=e=>e<new Date,Ue=e=>n(this,null,function*(){yield ze();for(const a of e){const e=he.value.find(e=>e.id===a);if(e&&!ke(a)){const t={product_id:a,product:e,quantity:1,unit_price:e.base_price||0,discount_percentage:0,notes:"",line_total:e.base_price||0};be.items.push(t)}}}),ke=e=>be.items.some(a=>a.product_id===e),je=()=>{const e=Pe.value;e&&(Ve.unit_price=e.base_price||0)},Se=()=>n(this,null,function*(){var e;if(ge.value)try{yield ge.value.validate();const n=Pe.value;if(!n)return void M.error("产品未找到");const d=Oe(Ve.quantity,Ve.unit_price||0,Ve.discount_percentage||0),i=(e=((e,a)=>{for(var t in a||(a={}))o.call(a,t)&&r(e,t,a[t]);if(l)for(var t of l(a))u.call(a,t)&&r(e,t,a[t]);return e})({},Ve),a(e,t({product:n,line_total:d})));be.items.push(i),Object.assign(Ve,{product_id:0,quantity:1,unit_price:0,discount_percentage:0,notes:""}),_e.value=!1,Ie(),M.success("项目添加成功")}catch(n){}}),$e=e=>n(this,null,function*(){try{yield x.confirm("您确定要删除这个项目吗？","确认",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"}),be.items.splice(e,1),Ie(),M.success("项目已删除")}catch(a){}}),Ne=e=>{const a=be.items[e];a&&(a.line_total=Oe(Number(a.quantity)||1,Number(a.unit_price)||0,Number(a.discount_percentage)||0))},Oe=(e,a,t=0)=>{const l=Number(e)*Number(a),o=l*Number(t)/100;return Number((l-o).toFixed(2))},Ie=()=>{},ze=()=>n(this,null,function*(){try{yield R.loadProducts({is_active:!0,per_page:100}),he.value=R.products}catch(e){M.error("加载产品失败")}}),Le=e=>n(this,null,function*(){try{M.info("报价编辑功能将在下一个版本中实现")}catch(e){M.error("加载报价失败"),C.push("/quotes")}}),Ae=()=>n(this,null,function*(){var e;if(fe.value)try{if(yield fe.value.validate(),0===be.items.length)return void M.error("请至少添加一个项目到报价单");K.value=!0;const e={customer_name:be.customer_name,customer_email:be.customer_email,customer_company:be.customer_company||void 0,customer_phone:be.customer_phone||void 0,customer_address:be.customer_address||void 0,discount_percentage:Number(be.discount_percentage)||0,tax_percentage:Number(be.tax_percentage)||0,valid_until:ve.value?ve.value.toISOString().split("T")[0]:void 0,notes:be.notes||void 0,terms_conditions:be.terms_conditions||void 0,items:be.items.map(e=>({product_id:Number(e.product_id),quantity:Number(e.quantity)||1,unit_price:Number(e.unit_price)||0,discount_percentage:Number(e.discount_percentage)||0,notes:e.notes||void 0}))};yield J.createQuote(e),M.success("报价创建成功"),C.push("/quotes")}catch(a){if(null==(e=a.response)?void 0:e.data){const e=a.response.data;if(e.details){const a=Object.entries(e.details).map(([e,a])=>"".concat(e,": ").concat(Array.isArray(a)?a.join(", "):a)).join("\n");M.error("数据验证错误:\n".concat(a))}else e.error?M.error(e.error):M.error("创建报价失败")}else M.error(a.message||"创建报价失败")}finally{K.value=!1}});return $(()=>n(this,null,function*(){yield ze(),ye.value&&(yield Le(q.params.id))})),(e,a)=>{const t=d,l=v,o=_,u=m,r=p,n=c,x=f,P=g,q=y,C=h,U=b,k=i,j=w,S=V,$=s;return Q(),N("div",Z,[O("div",G,[O("h1",null,z(ye.value?"编辑报价":"创建报价"),1),O("div",H,[I(t,{onClick:a[0]||(a[0]=a=>e.$router.go(-1))},{default:L(()=>a[20]||(a[20]=[D("取消",-1)])),_:1,__:[20]}),I(t,{type:"primary",onClick:Ae,loading:K.value},{default:L(()=>[D(z(ye.value?"更新报价":"保存报价"),1)]),_:1},8,["loading"])])]),I(k,{ref_key:"quoteFormRef",ref:fe,model:be,rules:we,"label-width":"140px"},{default:L(()=>[I(n,{class:"form-card"},{header:L(()=>a[21]||(a[21]=[O("div",{class:"card-header"},[O("span",{class:"card-title"},"客户信息")],-1)])),default:L(()=>[I(r,{gutter:20},{default:L(()=>[I(u,{span:12},{default:L(()=>[I(o,{label:"客户名称",prop:"customer_name"},{default:L(()=>[I(l,{modelValue:be.customer_name,"onUpdate:modelValue":a[1]||(a[1]=e=>be.customer_name=e),placeholder:"请输入客户名称"},null,8,["modelValue"])]),_:1})]),_:1}),I(u,{span:12},{default:L(()=>[I(o,{label:"客户邮箱",prop:"customer_email"},{default:L(()=>[I(l,{modelValue:be.customer_email,"onUpdate:modelValue":a[2]||(a[2]=e=>be.customer_email=e),placeholder:"请输入客户邮箱",type:"email"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),I(r,{gutter:20},{default:L(()=>[I(u,{span:12},{default:L(()=>[I(o,{label:"公司"},{default:L(()=>[I(l,{modelValue:be.customer_company,"onUpdate:modelValue":a[3]||(a[3]=e=>be.customer_company=e),placeholder:"请输入公司名称"},null,8,["modelValue"])]),_:1})]),_:1}),I(u,{span:12},{default:L(()=>[I(o,{label:"电话"},{default:L(()=>[I(l,{modelValue:be.customer_phone,"onUpdate:modelValue":a[4]||(a[4]=e=>be.customer_phone=e),placeholder:"请输入电话号码"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),I(o,{label:"地址"},{default:L(()=>[I(l,{modelValue:be.customer_address,"onUpdate:modelValue":a[5]||(a[5]=e=>be.customer_address=e),type:"textarea",rows:2,placeholder:"请输入客户地址"},null,8,["modelValue"])]),_:1})]),_:1}),I(n,{class:"form-card"},{header:L(()=>[O("div",W,[a[23]||(a[23]=O("span",{class:"card-title"},"报价项目",-1)),I(t,{type:"primary",size:"small",onClick:a[6]||(a[6]=e=>_e.value=!0),icon:"Plus"},{default:L(()=>a[22]||(a[22]=[D(" 添加项目 ",-1)])),_:1,__:[22]})])]),default:L(()=>[0===be.items.length?(Q(),N("div",X,[I(x,{description:"尚未添加项目"},{default:L(()=>[I(t,{type:"primary",onClick:a[7]||(a[7]=e=>_e.value=!0)},{default:L(()=>a[24]||(a[24]=[D(" 添加第一个项目 ",-1)])),_:1,__:[24]})]),_:1})])):(Q(),B(C,{key:1,data:be.items,style:{width:"100%"},class:"quote-items-table"},{default:L(()=>[I(P,{label:"产品","min-width":"200"},{default:L(({row:e})=>{var a,t;return[O("div",ee,[O("strong",null,z(null==(a=e.product)?void 0:a.name),1),O("div",ae,z(null==(t=e.product)?void 0:t.code),1)])]}),_:1}),I(P,{label:"数量",width:"120"},{default:L(({row:e,$index:a})=>[I(q,{modelValue:e.quantity,"onUpdate:modelValue":a=>e.quantity=a,min:1,max:9999,size:"small",onChange:e=>Ne(a)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),I(P,{label:"单价",width:"140"},{default:L(({row:e,$index:t})=>[I(q,{modelValue:e.unit_price,"onUpdate:modelValue":a=>e.unit_price=a,precision:2,min:0,size:"small",onChange:e=>Ne(t)},{prefix:L(()=>a[25]||(a[25]=[D("$",-1)])),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),I(P,{label:"折扣%",width:"120"},{default:L(({row:e,$index:t})=>[I(q,{modelValue:e.discount_percentage,"onUpdate:modelValue":a=>e.discount_percentage=a,precision:2,min:0,max:100,size:"small",onChange:e=>Ne(t)},{suffix:L(()=>a[26]||(a[26]=[D("%",-1)])),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),I(P,{label:"小计",width:"140"},{default:L(({row:e})=>[O("span",te,"$"+z(e.line_total.toLocaleString()),1)]),_:1}),I(P,{label:"操作",width:"100"},{default:L(({$index:e})=>[I(t,{type:"danger",size:"small",icon:"Delete",onClick:a=>$e(e),circle:""},null,8,["onClick"])]),_:1})]),_:1},8,["data"])),be.items.length>0?(Q(),N("div",le,[I(r,{gutter:20},{default:L(()=>[I(u,{span:12,offset:12},{default:L(()=>[O("div",oe,[O("div",ue,[a[27]||(a[27]=O("span",null,"小计:",-1)),O("span",null,"$"+z(qe.value.subtotal.toLocaleString()),1)]),qe.value.discount_amount>0?(Q(),N("div",re,[a[28]||(a[28]=O("span",null,"折扣:",-1)),O("span",null,"-$"+z(qe.value.discount_amount.toLocaleString()),1)])):E("",!0),qe.value.tax_amount>0?(Q(),N("div",ne,[a[29]||(a[29]=O("span",null,"税费:",-1)),O("span",null,"$"+z(qe.value.tax_amount.toLocaleString()),1)])):E("",!0),O("div",de,[a[30]||(a[30]=O("span",null,"总计:",-1)),O("span",null,"$"+z(qe.value.total.toLocaleString()),1)])])]),_:1})]),_:1})])):E("",!0)]),_:1}),I(n,{class:"form-card"},{header:L(()=>a[31]||(a[31]=[O("div",{class:"card-header"},[O("span",{class:"card-title"},"报价设置")],-1)])),default:L(()=>[I(r,{gutter:20},{default:L(()=>[I(u,{span:8},{default:L(()=>[I(o,{label:"整单折扣%"},{default:L(()=>[I(q,{modelValue:be.discount_percentage,"onUpdate:modelValue":a[8]||(a[8]=e=>be.discount_percentage=e),precision:2,min:0,max:100,onChange:Ie},{suffix:L(()=>a[32]||(a[32]=[D("%",-1)])),_:1},8,["modelValue"])]),_:1})]),_:1}),I(u,{span:8},{default:L(()=>[I(o,{label:"税率%"},{default:L(()=>[I(q,{modelValue:be.tax_percentage,"onUpdate:modelValue":a[9]||(a[9]=e=>be.tax_percentage=e),precision:2,min:0,max:100,onChange:Ie},{suffix:L(()=>a[33]||(a[33]=[D("%",-1)])),_:1},8,["modelValue"])]),_:1})]),_:1}),I(u,{span:8},{default:L(()=>[I(o,{label:"有效期至"},{default:L(()=>[I(U,{modelValue:ve.value,"onUpdate:modelValue":a[10]||(a[10]=e=>ve.value=e),type:"date",placeholder:"选择日期",style:{width:"100%"},"disabled-date":Ce},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),I(o,{label:"备注"},{default:L(()=>[I(l,{modelValue:be.notes,"onUpdate:modelValue":a[11]||(a[11]=e=>be.notes=e),type:"textarea",rows:3,placeholder:"添加备注或特殊说明..."},null,8,["modelValue"])]),_:1}),I(o,{label:"条款和条件"},{default:L(()=>[I(l,{modelValue:be.terms_conditions,"onUpdate:modelValue":a[12]||(a[12]=e=>be.terms_conditions=e),type:"textarea",rows:3,placeholder:"添加条款和条件..."},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["model"]),I($,{modelValue:_e.value,"onUpdate:modelValue":a[19]||(a[19]=e=>_e.value=e),title:"添加报价项目",width:"600px","close-on-click-modal":!1},{footer:L(()=>[O("span",me,[I(t,{onClick:a[18]||(a[18]=e=>_e.value=!1)},{default:L(()=>a[39]||(a[39]=[D("取消",-1)])),_:1,__:[39]}),I(t,{type:"primary",onClick:Se},{default:L(()=>a[40]||(a[40]=[D("添加项目",-1)])),_:1,__:[40]})])]),default:L(()=>[I(k,{ref_key:"itemFormRef",ref:ge,model:Ve,rules:xe,"label-width":"120px"},{default:L(()=>{var e;return[I(o,{label:"产品",prop:"product_id"},{default:L(()=>[I(S,{modelValue:Ve.product_id,"onUpdate:modelValue":a[13]||(a[13]=e=>Ve.product_id=e),placeholder:"选择产品",style:{width:"100%"},filterable:"",onChange:je},{default:L(()=>[(Q(!0),N(F,null,T(he.value,e=>(Q(),B(j,{key:e.id,label:"".concat(e.name," (").concat(e.code,")"),value:e.id,disabled:ke(e.id)},{default:L(()=>{var a;return[O("div",ie,[O("span",se,z(e.name),1),O("span",ce,"$"+z(null==(a=e.base_price)?void 0:a.toLocaleString()),1)])]}),_:2},1032,["label","value","disabled"]))),128))]),_:1},8,["modelValue"])]),_:1}),Pe.value?(Q(),N("div",pe,[a[36]||(a[36]=O("h4",null,"产品详情",-1)),O("p",null,[a[34]||(a[34]=O("strong",null,"描述:",-1)),D(" "+z(Pe.value.description),1)]),O("p",null,[a[35]||(a[35]=O("strong",null,"基础价格:",-1)),D(" $"+z(null==(e=Pe.value.base_price)?void 0:e.toLocaleString()),1)])])):E("",!0),I(r,{gutter:20},{default:L(()=>[I(u,{span:12},{default:L(()=>[I(o,{label:"数量",prop:"quantity"},{default:L(()=>[I(q,{modelValue:Ve.quantity,"onUpdate:modelValue":a[14]||(a[14]=e=>Ve.quantity=e),min:1,max:9999,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),I(u,{span:12},{default:L(()=>[I(o,{label:"单价",prop:"unit_price"},{default:L(()=>[I(q,{modelValue:Ve.unit_price,"onUpdate:modelValue":a[15]||(a[15]=e=>Ve.unit_price=e),precision:2,min:0,style:{width:"100%"}},{prefix:L(()=>a[37]||(a[37]=[D("$",-1)])),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),I(o,{label:"项目折扣%"},{default:L(()=>[I(q,{modelValue:Ve.discount_percentage,"onUpdate:modelValue":a[16]||(a[16]=e=>Ve.discount_percentage=e),precision:2,min:0,max:100,style:{width:"200px"}},{suffix:L(()=>a[38]||(a[38]=[D("%",-1)])),_:1},8,["modelValue"])]),_:1}),I(o,{label:"备注"},{default:L(()=>[I(l,{modelValue:Ve.notes,"onUpdate:modelValue":a[17]||(a[17]=e=>Ve.notes=e),type:"textarea",rows:2,placeholder:"添加项目备注..."},null,8,["modelValue"])]),_:1})]}),_:1},8,["model"])]),_:1},8,["modelValue"])])}}});export{_e as _,Y as u};
