var W=Object.defineProperty,ge=Object.defineProperties;var ve=Object.getOwnPropertyDescriptors;var H=Object.getOwnPropertySymbols;var ye=Object.prototype.hasOwnProperty,be=Object.prototype.propertyIsEnumerable;var K=(g,m,c)=>m in g?W(g,m,{enumerable:!0,configurable:!0,writable:!0,value:c}):g[m]=c,Y=(g,m)=>{for(var c in m||(m={}))ye.call(m,c)&&K(g,c,m[c]);if(H)for(var c of H(m))be.call(m,c)&&K(g,c,m[c]);return g},Z=(g,m)=>ge(g,ve(m)),p=(g,m)=>W(g,"name",{value:m,configurable:!0});var k=(g,m,c)=>new Promise((R,T)=>{var q=w=>{try{U(c.next(w))}catch(E){T(E)}},$=w=>{try{U(c.throw(w))}catch(E){T(E)}},U=w=>w.done?R(w.value):Promise.resolve(w.value).then(q,$);U((c=c.apply(g,m)).next())});import{s as V,_ as Ve}from"./index-CoBZUWE1.js";/* empty css                  *//* empty css                     *//* empty css                *//* empty css                       *//* empty css                 *//* empty css                        *//* empty css                    */import"./el-tooltip-l0sNRNKZ.js";/* empty css                        *//* empty css                 *//* empty css                *//* empty css               */import"./el-form-item-l0sNRNKZ.js";import{x as we,r as S,c as z,aB as xe,X as G,w as J,j as qe,y as I,A as n,Q as t,O as b,I as o,aC as Ce,M as y,H as ee,K as A,P as ke,a6 as $e,z as x}from"./vendor-vue-XfLkFKXI.js";import{u as Ue}from"./quotes-BbFL_Tm9.js";import{u as Ee}from"./products-uvuy7ZPA.js";import{d as Ne,af as Se,a as Ie,O as Te,M as De,N as Fe,ag as Pe,W as Re,ak as Be,S as Le,Z as Ae,R as Oe,a$ as Qe,X as ze,Y as Me,ae as je}from"./vendor-ui-CE-ZhXxH.js";import"./vendor-pdf-BeW0Xq92.js";import"./vendor-utils-B8vW8fJV.js";import"./products-CqbSQiZB.js";const he={class:"create-quote"},Xe={class:"page-header"},He={class:"header-actions"},Ke={class:"card-header"},We={key:0,class:"empty-items"},Ye={class:"product-info"},Ze={class:"product-code"},Ge={class:"line-total"},Je={key:2,class:"quote-totals"},et={class:"totals-section"},tt={class:"total-row"},ot={key:0,class:"total-row"},lt={key:1,class:"total-row"},at={class:"total-row final-total"},st={class:"product-option"},nt={class:"product-name"},rt={class:"product-price"},ut={key:0,class:"product-preview"},it={class:"dialog-footer"},dt=we({__name:"CreateQuote",setup(g){const m=xe(),c=Ce(),R=Ee(),T=S(!1),q=S(!1),$=S(new Date(Date.now()+30*24*60*60*1e3)),U=S(),w=S(),E=z(()=>!!m.params.id);S(null);const B=S([]),a=G({customer_name:"",customer_email:"",customer_company:"",customer_phone:"",customer_address:"",items:[],discount_percentage:0,tax_percentage:0,notes:"",terms_conditions:""}),_=G({product_id:0,quantity:1,unit_price:0,discount_percentage:0,notes:""}),te={customer_name:[{required:!0,message:"请输入客户名称",trigger:"blur"}],customer_email:[{required:!0,message:"请输入客户邮箱",trigger:"blur"},{type:"email",message:"请输入有效的邮箱地址",trigger:"blur"}]},oe={product_id:[{required:!0,message:"请选择产品",trigger:"change"}],quantity:[{required:!0,message:"请输入数量",trigger:"blur"}],unit_price:[{required:!0,message:"请输入单价",trigger:"blur"}]},P=z(()=>B.value.find(s=>s.id===_.product_id)),D=z(()=>{const s=a.items.reduce((f,N)=>f+N.line_total,0),e=s*(a.discount_percentage||0)/100,r=s-e,i=r*(a.tax_percentage||0)/100,d=r+i;return{subtotal:s,discount_amount:e,tax_amount:i,total:d}});J(()=>m.query.products,s=>{if(s&&typeof s=="string"){const e=s.split(",").map(r=>parseInt(r,10));ae(e)}},{immediate:!0}),J($,s=>{s&&(a.valid_until=s.toISOString().split("T")[0])});const le=p(s=>s<new Date,"disabledDate"),ae=p(s=>k(this,null,function*(){yield h();for(const e of s){const r=B.value.find(i=>i.id===e);if(r&&!M(e)){const i={product_id:e,product:r,quantity:1,unit_price:r.base_price||0,discount_percentage:0,notes:"",line_total:r.base_price||0};a.items.push(i)}}}),"preAddProducts"),M=p(s=>a.items.some(e=>e.product_id===s),"isProductAlreadyAdded"),se=p(()=>{const s=P.value;s&&(_.unit_price=s.base_price||0)},"onProductSelect"),ne=p(()=>k(this,null,function*(){if(w.value)try{yield w.value.validate();const s=P.value;if(!s){V.error("产品未找到");return}const e=j(_.quantity,_.unit_price||0,_.discount_percentage||0),r=Z(Y({},_),{product:s,line_total:e});a.items.push(r),Object.assign(_,{product_id:0,quantity:1,unit_price:0,discount_percentage:0,notes:""}),q.value=!1,L(),V.success("项目添加成功")}catch(s){}}),"addItem"),re=p(s=>k(this,null,function*(){try{yield je.confirm("您确定要删除这个项目吗？","确认",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"}),a.items.splice(s,1),L(),V.success("项目已删除")}catch(e){}}),"removeItem"),O=p(s=>{const e=a.items[s];e&&(e.line_total=j(Number(e.quantity)||1,Number(e.unit_price)||0,Number(e.discount_percentage)||0))},"updateItemTotal"),j=p((s,e,r=0)=>{const i=Number(s)*Number(e),d=i*Number(r)/100;return Number((i-d).toFixed(2))},"calculateLineTotal"),L=p(()=>{},"calculateTotals"),h=p(()=>k(this,null,function*(){try{yield R.loadProducts({is_active:!0,per_page:100}),B.value=R.products}catch(s){V.error("加载产品失败")}}),"loadProducts"),ue=p(s=>k(this,null,function*(){try{V.info("报价编辑功能将在下一个版本中实现")}catch(e){V.error("加载报价失败"),c.push("/quotes")}}),"loadExistingQuote"),ie=p(()=>k(this,null,function*(){var s;if(U.value)try{if(yield U.value.validate(),a.items.length===0){V.error("请至少添加一个项目到报价单");return}T.value=!0;const e={customer_name:a.customer_name,customer_email:a.customer_email,customer_company:a.customer_company||void 0,customer_phone:a.customer_phone||void 0,customer_address:a.customer_address||void 0,discount_percentage:Number(a.discount_percentage)||0,tax_percentage:Number(a.tax_percentage)||0,valid_until:$.value?$.value.toISOString().split("T")[0]:void 0,notes:a.notes||void 0,terms_conditions:a.terms_conditions||void 0,items:a.items.map(i=>({product_id:Number(i.product_id),quantity:Number(i.quantity)||1,unit_price:Number(i.unit_price)||0,discount_percentage:Number(i.discount_percentage)||0,notes:i.notes||void 0}))},r=yield Ue.createQuote(e);V.success("报价创建成功"),c.push("/quotes")}catch(e){if((s=e.response)!=null&&s.data){const r=e.response.data;if(r.details){const i=Object.entries(r.details).map(([d,f])=>"".concat(d,": ").concat(Array.isArray(f)?f.join(", "):f)).join("\n");V.error("数据验证错误:\n".concat(i))}else r.error?V.error(r.error):V.error("创建报价失败")}else V.error(e.message||"创建报价失败")}finally{T.value=!1}}),"saveQuote");return qe(()=>k(this,null,function*(){yield h(),E.value&&(yield ue(m.params.id))})),(s,e)=>{const r=Ne,i=Re,d=Pe,f=Fe,N=De,Q=Te,de=Be,F=Le,C=Ae,me=Oe,pe=Qe,X=Se,ce=Me,_e=ze,fe=Ie;return x(),I("div",he,[n("div",Xe,[n("h1",null,b(E.value?"编辑报价":"创建报价"),1),n("div",He,[t(r,{onClick:e[0]||(e[0]=l=>s.$router.go(-1))},{default:o(()=>e[20]||(e[20]=[y("取消",-1)])),_:1,__:[20]}),t(r,{type:"primary",onClick:ie,loading:T.value},{default:o(()=>[y(b(E.value?"更新报价":"保存报价"),1)]),_:1},8,["loading"])])]),t(X,{ref_key:"quoteFormRef",ref:U,model:a,rules:te,"label-width":"140px"},{default:o(()=>[t(Q,{class:"form-card"},{header:o(()=>e[21]||(e[21]=[n("div",{class:"card-header"},[n("span",{class:"card-title"},"客户信息")],-1)])),default:o(()=>[t(N,{gutter:20},{default:o(()=>[t(f,{span:12},{default:o(()=>[t(d,{label:"客户名称",prop:"customer_name"},{default:o(()=>[t(i,{modelValue:a.customer_name,"onUpdate:modelValue":e[1]||(e[1]=l=>a.customer_name=l),placeholder:"请输入客户名称"},null,8,["modelValue"])]),_:1})]),_:1}),t(f,{span:12},{default:o(()=>[t(d,{label:"客户邮箱",prop:"customer_email"},{default:o(()=>[t(i,{modelValue:a.customer_email,"onUpdate:modelValue":e[2]||(e[2]=l=>a.customer_email=l),placeholder:"请输入客户邮箱",type:"email"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(N,{gutter:20},{default:o(()=>[t(f,{span:12},{default:o(()=>[t(d,{label:"公司"},{default:o(()=>[t(i,{modelValue:a.customer_company,"onUpdate:modelValue":e[3]||(e[3]=l=>a.customer_company=l),placeholder:"请输入公司名称"},null,8,["modelValue"])]),_:1})]),_:1}),t(f,{span:12},{default:o(()=>[t(d,{label:"电话"},{default:o(()=>[t(i,{modelValue:a.customer_phone,"onUpdate:modelValue":e[4]||(e[4]=l=>a.customer_phone=l),placeholder:"请输入电话号码"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(d,{label:"地址"},{default:o(()=>[t(i,{modelValue:a.customer_address,"onUpdate:modelValue":e[5]||(e[5]=l=>a.customer_address=l),type:"textarea",rows:2,placeholder:"请输入客户地址"},null,8,["modelValue"])]),_:1})]),_:1}),t(Q,{class:"form-card"},{header:o(()=>[n("div",Ke,[e[23]||(e[23]=n("span",{class:"card-title"},"报价项目",-1)),t(r,{type:"primary",size:"small",onClick:e[6]||(e[6]=l=>q.value=!0),icon:"Plus"},{default:o(()=>e[22]||(e[22]=[y(" 添加项目 ",-1)])),_:1,__:[22]})])]),default:o(()=>[a.items.length===0?(x(),I("div",We,[t(de,{description:"尚未添加项目"},{default:o(()=>[t(r,{type:"primary",onClick:e[7]||(e[7]=l=>q.value=!0)},{default:o(()=>e[24]||(e[24]=[y(" 添加第一个项目 ",-1)])),_:1,__:[24]})]),_:1})])):(x(),ee(me,{key:1,data:a.items,style:{width:"100%"},class:"quote-items-table"},{default:o(()=>[t(F,{label:"产品","min-width":"200"},{default:o(({row:l})=>{var u,v;return[n("div",Ye,[n("strong",null,b((u=l.product)==null?void 0:u.name),1),n("div",Ze,b((v=l.product)==null?void 0:v.code),1)])]}),_:1}),t(F,{label:"数量",width:"120"},{default:o(({row:l,$index:u})=>[t(C,{modelValue:l.quantity,"onUpdate:modelValue":p(v=>l.quantity=v,"onUpdate:modelValue"),min:1,max:9999,size:"small",onChange:p(v=>O(u),"onChange")},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),t(F,{label:"单价",width:"140"},{default:o(({row:l,$index:u})=>[t(C,{modelValue:l.unit_price,"onUpdate:modelValue":p(v=>l.unit_price=v,"onUpdate:modelValue"),precision:2,min:0,size:"small",onChange:p(v=>O(u),"onChange")},{prefix:o(()=>e[25]||(e[25]=[y("$",-1)])),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),t(F,{label:"折扣%",width:"120"},{default:o(({row:l,$index:u})=>[t(C,{modelValue:l.discount_percentage,"onUpdate:modelValue":p(v=>l.discount_percentage=v,"onUpdate:modelValue"),precision:2,min:0,max:100,size:"small",onChange:p(v=>O(u),"onChange")},{suffix:o(()=>e[26]||(e[26]=[y("%",-1)])),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),t(F,{label:"小计",width:"140"},{default:o(({row:l})=>[n("span",Ge,"$"+b(l.line_total.toLocaleString()),1)]),_:1}),t(F,{label:"操作",width:"100"},{default:o(({$index:l})=>[t(r,{type:"danger",size:"small",icon:"Delete",onClick:p(u=>re(l),"onClick"),circle:""},null,8,["onClick"])]),_:1})]),_:1},8,["data"])),a.items.length>0?(x(),I("div",Je,[t(N,{gutter:20},{default:o(()=>[t(f,{span:12,offset:12},{default:o(()=>[n("div",et,[n("div",tt,[e[27]||(e[27]=n("span",null,"小计:",-1)),n("span",null,"$"+b(D.value.subtotal.toLocaleString()),1)]),D.value.discount_amount>0?(x(),I("div",ot,[e[28]||(e[28]=n("span",null,"折扣:",-1)),n("span",null,"-$"+b(D.value.discount_amount.toLocaleString()),1)])):A("",!0),D.value.tax_amount>0?(x(),I("div",lt,[e[29]||(e[29]=n("span",null,"税费:",-1)),n("span",null,"$"+b(D.value.tax_amount.toLocaleString()),1)])):A("",!0),n("div",at,[e[30]||(e[30]=n("span",null,"总计:",-1)),n("span",null,"$"+b(D.value.total.toLocaleString()),1)])])]),_:1})]),_:1})])):A("",!0)]),_:1}),t(Q,{class:"form-card"},{header:o(()=>e[31]||(e[31]=[n("div",{class:"card-header"},[n("span",{class:"card-title"},"报价设置")],-1)])),default:o(()=>[t(N,{gutter:20},{default:o(()=>[t(f,{span:8},{default:o(()=>[t(d,{label:"整单折扣%"},{default:o(()=>[t(C,{modelValue:a.discount_percentage,"onUpdate:modelValue":e[8]||(e[8]=l=>a.discount_percentage=l),precision:2,min:0,max:100,onChange:L},{suffix:o(()=>e[32]||(e[32]=[y("%",-1)])),_:1},8,["modelValue"])]),_:1})]),_:1}),t(f,{span:8},{default:o(()=>[t(d,{label:"税率%"},{default:o(()=>[t(C,{modelValue:a.tax_percentage,"onUpdate:modelValue":e[9]||(e[9]=l=>a.tax_percentage=l),precision:2,min:0,max:100,onChange:L},{suffix:o(()=>e[33]||(e[33]=[y("%",-1)])),_:1},8,["modelValue"])]),_:1})]),_:1}),t(f,{span:8},{default:o(()=>[t(d,{label:"有效期至"},{default:o(()=>[t(pe,{modelValue:$.value,"onUpdate:modelValue":e[10]||(e[10]=l=>$.value=l),type:"date",placeholder:"选择日期",style:{width:"100%"},"disabled-date":le},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(d,{label:"备注"},{default:o(()=>[t(i,{modelValue:a.notes,"onUpdate:modelValue":e[11]||(e[11]=l=>a.notes=l),type:"textarea",rows:3,placeholder:"添加备注或特殊说明..."},null,8,["modelValue"])]),_:1}),t(d,{label:"条款和条件"},{default:o(()=>[t(i,{modelValue:a.terms_conditions,"onUpdate:modelValue":e[12]||(e[12]=l=>a.terms_conditions=l),type:"textarea",rows:3,placeholder:"添加条款和条件..."},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["model"]),t(fe,{modelValue:q.value,"onUpdate:modelValue":e[19]||(e[19]=l=>q.value=l),title:"添加报价项目",width:"600px","close-on-click-modal":!1},{footer:o(()=>[n("span",it,[t(r,{onClick:e[18]||(e[18]=l=>q.value=!1)},{default:o(()=>e[39]||(e[39]=[y("取消",-1)])),_:1,__:[39]}),t(r,{type:"primary",onClick:ne},{default:o(()=>e[40]||(e[40]=[y("添加项目",-1)])),_:1,__:[40]})])]),default:o(()=>[t(X,{ref_key:"itemFormRef",ref:w,model:_,rules:oe,"label-width":"120px"},{default:o(()=>{var l;return[t(d,{label:"产品",prop:"product_id"},{default:o(()=>[t(_e,{modelValue:_.product_id,"onUpdate:modelValue":e[13]||(e[13]=u=>_.product_id=u),placeholder:"选择产品",style:{width:"100%"},filterable:"",onChange:se},{default:o(()=>[(x(!0),I(ke,null,$e(B.value,u=>(x(),ee(ce,{key:u.id,label:"".concat(u.name," (").concat(u.code,")"),value:u.id,disabled:M(u.id)},{default:o(()=>{var v;return[n("div",st,[n("span",nt,b(u.name),1),n("span",rt,"$"+b((v=u.base_price)==null?void 0:v.toLocaleString()),1)])]}),_:2},1032,["label","value","disabled"]))),128))]),_:1},8,["modelValue"])]),_:1}),P.value?(x(),I("div",ut,[e[36]||(e[36]=n("h4",null,"产品详情",-1)),n("p",null,[e[34]||(e[34]=n("strong",null,"描述:",-1)),y(" "+b(P.value.description),1)]),n("p",null,[e[35]||(e[35]=n("strong",null,"基础价格:",-1)),y(" $"+b((l=P.value.base_price)==null?void 0:l.toLocaleString()),1)])])):A("",!0),t(N,{gutter:20},{default:o(()=>[t(f,{span:12},{default:o(()=>[t(d,{label:"数量",prop:"quantity"},{default:o(()=>[t(C,{modelValue:_.quantity,"onUpdate:modelValue":e[14]||(e[14]=u=>_.quantity=u),min:1,max:9999,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),t(f,{span:12},{default:o(()=>[t(d,{label:"单价",prop:"unit_price"},{default:o(()=>[t(C,{modelValue:_.unit_price,"onUpdate:modelValue":e[15]||(e[15]=u=>_.unit_price=u),precision:2,min:0,style:{width:"100%"}},{prefix:o(()=>e[37]||(e[37]=[y("$",-1)])),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(d,{label:"项目折扣%"},{default:o(()=>[t(C,{modelValue:_.discount_percentage,"onUpdate:modelValue":e[16]||(e[16]=u=>_.discount_percentage=u),precision:2,min:0,max:100,style:{width:"200px"}},{suffix:o(()=>e[38]||(e[38]=[y("%",-1)])),_:1},8,["modelValue"])]),_:1}),t(d,{label:"备注"},{default:o(()=>[t(i,{modelValue:_.notes,"onUpdate:modelValue":e[17]||(e[17]=u=>_.notes=u),type:"textarea",rows:2,placeholder:"添加项目备注..."},null,8,["modelValue"])]),_:1})]}),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),Dt=Ve(dt,[["__scopeId","data-v-590e0e56"]]);export{Dt as default};
