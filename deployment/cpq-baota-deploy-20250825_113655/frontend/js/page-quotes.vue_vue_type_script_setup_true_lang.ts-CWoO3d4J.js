var e=Object.defineProperty,a=Object.defineProperties,t=Object.getOwnPropertyDescriptors,l=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,n=(a,t,l)=>t in a?e(a,t,{enumerable:!0,configurable:!0,writable:!0,value:l}):a[t]=l,s=(e,a,t)=>new Promise((l,o)=>{var r=e=>{try{s(t.next(e))}catch(a){o(a)}},n=e=>{try{s(t.throw(e))}catch(a){o(a)}},s=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,n);s((t=t.apply(e,a)).next())});import{E as u,I as i,a as d,d as c,p,g as m,h as _,i as f,U as v,j as y,u as g,Y as h,k as b,_ as w,$ as x,f as k,ad as q,aS as C,aU as V,aV as D,a1 as j,a2 as P,b as z}from"./element-plus-DR0qywX_.js";import{z as S,r as U,b as T,Z as O,l as A,A as F,C as B,S as I,J as M,M as Q,K as N,an as E,P as L,u as $,O as H,Q as J,L as K,F as R,az as Y,B as Z}from"./vue-BMWQU0Ry.js";import{u as G,o as W}from"./api-BHu6TLr6.js";import{s as X,a as ee,u as ae}from"./utils-BjNHK8wL.js";const te={class:"quotes"},le={class:"page-header"},oe={class:"header-actions"},re={class:"result-count"},ne={class:"customer-info"},se={class:"customer-details"},ue={key:0,class:"company"},ie={class:"email"},de={class:"amount"},ce={class:"date-info"},pe={class:"created-by"},me={class:"validity-info"},_e={class:"action-buttons"},fe={class:"pagination-wrapper"},ve=S({__name:"Quotes",setup(e){const S=Y(),ve=G(),ye=U([]),ge=U(!1),he=U(0),be=U(1),we=U(20),xe=U(""),ke=U(null),qe=U(),Ce=T(()=>{var e;return null==(e=ve.user)?void 0:e.id}),Ve=O({search:"",status:"",min_amount:null,max_amount:null,date_from:"",date_to:"",created_by:null,page:1,per_page:20}),De=O({field:"created_at",order:"desc"}),je=T(()=>!!(Ve.search||Ve.status||Ve.min_amount||Ve.max_amount||Ve.date_from||Ve.date_to||Ve.created_by)),Pe=e=>({draft:"草稿",pending:"待审批",approved:"已审批",rejected:"已拒绝",expired:"已过期"}[e]||e.charAt(0).toUpperCase()+e.slice(1)),ze=e=>e?new Date(e).toLocaleDateString("zh-CN",{month:"short",day:"numeric",year:"numeric"}):"无",Se=e=>{if(!e)return"unknown";const a=new Date(e),t=new Date,l=a.getTime()-t.getTime(),o=Math.ceil(l/864e5);return o<0?"expired":o<=7?"expiring":"valid"},Ue=e=>{if(!e)return"No expiry";const a=new Date(e),t=new Date,l=a.getTime()-t.getTime(),o=Math.ceil(l/864e5);return o<0?"Expired":0===o?"Today":o<=7?"".concat(o,"d left"):"Valid"},Te=e=>e.created_by===Ce.value||ve.isAdmin,Oe=()=>{qe.value&&clearTimeout(qe.value),qe.value=setTimeout(()=>{Ve.search=xe.value,be.value=1,Qe()},300)},Ae=()=>{xe.value="",Ve.search="",Qe()},Fe=e=>{e?(Ve.date_from=e[0].toISOString().split("T")[0],Ve.date_to=e[1].toISOString().split("T")[0]):(Ve.date_from="",Ve.date_to=""),Qe()},Be=()=>{xe.value="",ke.value=null,Object.assign(Ve,{search:"",status:"",min_amount:null,max_amount:null,date_from:"",date_to:"",created_by:null}),be.value=1,Qe()},Ie=()=>{De.order="asc"===De.order?"desc":"asc",Qe()},Me=({prop:e,order:a})=>{e&&a&&(De.field=e,De.order="ascending"===a?"asc":"desc",Qe())},Qe=()=>s(this,null,function*(){var e,s,u;ge.value=!0;try{const e=(s=((e,a)=>{for(var t in a||(a={}))o.call(a,t)&&n(e,t,a[t]);if(l)for(var t of l(a))r.call(a,t)&&n(e,t,a[t]);return e})({},Ve),u={page:be.value,per_page:we.value,sort_by:De.field,sort_order:De.order},a(s,t(u))),i=yield W.getAllQuotes(e);i&&i.quotes&&Array.isArray(i.quotes)?(ye.value=i.quotes,i.pagination&&void 0!==i.pagination.total?he.value=i.pagination.total:void 0!==i.total?he.value=i.total:he.value=i.quotes.length):i&&Array.isArray(i)?(ye.value=i,he.value=i.length):(ye.value=[],he.value=0,X.warning("无法加载报价数据，请检查服务器连接"))}catch(i){if(ye.value=[],he.value=0,i.response){const a=i.response.status,t=(null==(e=i.response.data)?void 0:e.message)||i.message;404===a?X.error("Quotes endpoint not found. Please check API configuration."):a>=500?X.error("Server error. Please try again later."):X.error("Failed to load quotes: ".concat(t))}else i.request?X.error("Network error. Please check your connection."):X.error("Failed to load quotes")}finally{ge.value=!1}}),Ne=e=>{be.value=e,Qe()},Ee=e=>{we.value=e,be.value=1,Qe()},Le=e=>s(this,[e],function*({action:e,quote:a}){switch(e){case"duplicate":yield $e();break;case"pdf":yield He(a);break;case"delete":yield Je(a)}}),$e=e=>s(this,null,function*(){try{yield z.confirm("This will create a new quote with the same items and customer information. Continue?","Duplicate Quote",{confirmButtonText:"Create Duplicate",cancelButtonText:"Cancel",type:"info"}),X.info("Duplicate functionality will be implemented in the next phase")}catch(e){}}),He=e=>s(this,null,function*(){try{const a=yield ee(e);yield ae.downloadPDF(a,"报价单-".concat(e.quote_number)),X.success("PDF导出成功")}catch(a){X.error("PDF导出失败")}}),Je=e=>s(this,null,function*(){var a,t;try{const a={approved:"此报价已通过审批，删除后将无法恢复。",pending:"此报价正在等待审批，删除后将无法恢复。",rejected:"此报价已被拒绝，确认删除？",expired:"此报价已过期，确认删除？",draft:"确认删除此草稿报价？"}[e.status]||"确认删除此报价？",t=Pe(e.status);yield z.confirm("".concat(a,"\n\n报价单号: ").concat(e.quote_number,"\n状态: ").concat(t,"\n\n此操作不可撤销，请谨慎操作。"),"删除报价确认",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",dangerouslyUseHTMLString:!1});const l=(yield W.deleteQuote(e.id)).message||"报价删除成功";X.success(l),Qe()}catch(l){if("cancel"===l)return;let e="删除报价失败";if(l.response){const o=l.response.status,r=(null==(a=l.response.data)?void 0:a.error)||(null==(t=l.response.data)?void 0:t.message);switch(o){case 403:e="权限不足："+(r||"您没有权限删除这个报价");break;case 404:e="报价不存在或已被删除";break;case 500:e="服务器错误："+(r||"请稍后重试");break;default:e=r||"删除失败 (错误代码: ".concat(o,")")}}else e=l.request?"网络连接错误，请检查网络后重试":l.message||"未知错误";X.error(e)}}),Ke=()=>{X.info("Bulk export functionality will be implemented in the next phase")};return A(()=>{Qe()}),(e,a)=>{const t=c,l=d,o=E("router-link"),r=f,n=_,s=m,z=g,U=y,T=h,O=b,A=u,Y=x,G=k,W=E("Menu"),X=q,ee=D,ae=V,qe=C,$e=j,He=P,Je=i,Re=w;return Z(),F("div",te,[B("div",le,[a[9]||(a[9]=B("h1",null,"报价管理",-1)),B("div",oe,[I(o,{to:"/quotes/create"},{default:N(()=>[I(l,{type:"primary",size:"large"},{default:N(()=>[I(t,null,{default:N(()=>[I($(p))]),_:1}),a[8]||(a[8]=L(" 创建报价 ",-1))]),_:1,__:[8]})]),_:1})])]),I(A,{class:"filter-card"},{default:N(()=>[I(s,{gutter:20,class:"search-row"},{default:N(()=>[I(n,{span:24},{default:N(()=>[I(r,{modelValue:xe.value,"onUpdate:modelValue":a[0]||(a[0]=e=>xe.value=e),placeholder:"按报价单号、客户姓名、公司或邮箱搜索...",clearable:"",size:"large",onInput:Oe,onClear:Ae},{prefix:N(()=>[I(t,null,{default:N(()=>[I($(v))]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),I(s,{gutter:20,class:"filter-row"},{default:N(()=>[I(n,{span:4},{default:N(()=>[I(U,{modelValue:Ve.status,"onUpdate:modelValue":a[1]||(a[1]=e=>Ve.status=e),placeholder:"所有状态",clearable:"",onChange:Qe,style:{width:"100%"}},{default:N(()=>[I(z,{label:"所有状态",value:""}),I(z,{label:"草稿",value:"draft"}),I(z,{label:"待审批",value:"pending"}),I(z,{label:"已审批",value:"approved"}),I(z,{label:"已拒绝",value:"rejected"}),I(z,{label:"已过期",value:"expired"})]),_:1},8,["modelValue"])]),_:1}),I(n,{span:5},{default:N(()=>[I(T,{modelValue:ke.value,"onUpdate:modelValue":a[2]||(a[2]=e=>ke.value=e),type:"daterange","start-placeholder":"开始日期","end-placeholder":"结束日期",onChange:Fe,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),I(n,{span:4},{default:N(()=>[I(O,{modelValue:Ve.min_amount,"onUpdate:modelValue":a[3]||(a[3]=e=>Ve.min_amount=e),placeholder:"最小金额",min:0,precision:2,onChange:Qe,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),I(n,{span:4},{default:N(()=>[I(O,{modelValue:Ve.max_amount,"onUpdate:modelValue":a[4]||(a[4]=e=>Ve.max_amount=e),placeholder:"最大金额",min:0,precision:2,onChange:Qe,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),I(n,{span:4},{default:N(()=>[I(U,{modelValue:Ve.created_by,"onUpdate:modelValue":a[5]||(a[5]=e=>Ve.created_by=e),placeholder:"创建者",clearable:"",onChange:Qe,style:{width:"100%"}},{default:N(()=>[I(z,{label:"所有用户",value:""}),I(z,{label:"我的报价",value:Ce.value},null,8,["value"])]),_:1},8,["modelValue"])]),_:1}),I(n,{span:3},{default:N(()=>[I(U,{modelValue:De.field,"onUpdate:modelValue":a[6]||(a[6]=e=>De.field=e),placeholder:"排序方式",onChange:Qe,style:{width:"100%"}},{default:N(()=>[I(z,{label:"创建日期",value:"created_at"}),I(z,{label:"金额",value:"total_price"}),I(z,{label:"客户",value:"customer_name"}),I(z,{label:"报价单号",value:"quote_number"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),I(s,{gutter:20,class:"action-row"},{default:N(()=>[I(n,{span:12},{default:N(()=>[I(l,{onClick:Be,icon:"Refresh"},{default:N(()=>a[10]||(a[10]=[L("重置筛选",-1)])),_:1,__:[10]}),I(l,{onClick:Ie,link:""},{default:N(()=>[I(t,null,{default:N(()=>[(Z(),M(H("asc"===De.order?"SortUp":"SortDown")))]),_:1}),L(" "+J("asc"===De.order?"升序":"降序"),1)]),_:1})]),_:1}),I(n,{span:12,class:"text-right"},{default:N(()=>[B("span",re,"找到 "+J(he.value)+" 个报价",1),I(l,{onClick:Ke,link:"",icon:"Download"},{default:N(()=>a[11]||(a[11]=[L("导出",-1)])),_:1,__:[11]})]),_:1})]),_:1})]),_:1}),I(A,null,{default:N(()=>[K((Z(),M($e,{data:ye.value,style:{width:"100%"},onSortChange:Me,stripe:""},{default:N(()=>[I(Y,{prop:"quote_number",label:"报价单号",width:"140",sortable:"custom"},{default:N(({row:e})=>[I(o,{to:"/quotes/".concat(e.id),class:"quote-link"},{default:N(()=>[B("strong",null,J(e.quote_number),1)]),_:2},1032,["to"])]),_:1}),I(Y,{label:"客户","min-width":"200",sortable:"custom",prop:"customer_name"},{default:N(({row:e})=>[B("div",ne,[B("strong",null,J(e.customer_name),1),B("div",se,[e.customer_company?(Z(),F("div",ue,J(e.customer_company),1)):Q("",!0),B("div",ie,J(e.customer_email),1)])])]),_:1}),I(Y,{prop:"status",label:"状态",width:"130",sortable:"custom"},{default:N(({row:e})=>{return[I(G,{type:(a=e.status,{draft:"info",pending:"warning",approved:"success",rejected:"danger",expired:"warning"}[a]||"info"),size:"large"},{default:N(()=>[L(J(Pe(e.status)),1)]),_:2},1032,["type"])];var a}),_:1}),I(Y,{label:"项目",width:"80",align:"center"},{default:N(({row:e})=>{return[I(X,{value:(a=e,a.items&&Array.isArray(a.items)?a.items.length:a.product_id||a.product?1:0),type:"primary"},{default:N(()=>[I(t,null,{default:N(()=>[I(W)]),_:1})]),_:2},1032,["value"])];var a}),_:1}),I(Y,{prop:"total_price",label:"金额",width:"140",sortable:"custom",align:"right"},{default:N(({row:e})=>{return[B("span",de," $"+J((a=e.total_price,"number"!=typeof a||isNaN(a)?"0.00":a.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}))),1)];var a}),_:1}),I(Y,{prop:"created_at",label:"创建时间",width:"120",sortable:"custom"},{default:N(({row:e})=>{return[B("div",ce,[B("div",null,J(ze(e.created_at)),1),B("div",pe,J((a=e,(null==(t=a.created_by_user)?void 0:t.name)||"Unknown User")),1)])];var a,t}),_:1}),I(Y,{label:"有效期",width:"120"},{default:N(({row:e})=>[B("div",me,[B("div",null,J(ze(e.valid_until)),1),B("div",{class:R(["validity-status",Se(e.valid_until)])},J(Ue(e.valid_until)),3)])]),_:1}),I(Y,{label:"操作",width:"180",fixed:"right"},{default:N(({row:e})=>{return[B("div",_e,[I(o,{to:"/quotes/".concat(e.id)},{default:N(()=>[I(l,{size:"small",type:"primary",link:"",icon:"View"},{default:N(()=>a[12]||(a[12]=[L("查看",-1)])),_:1,__:[12]})]),_:2},1032,["to"]),"draft"===e.status&&(t=e,t.created_by===Ce.value||ve.isAdmin)?(Z(),M(l,{key:0,size:"small",type:"primary",onClick:a=>(e=>{S.push("/quotes/".concat(e.id,"/edit"))})(e),icon:"Edit"},{default:N(()=>a[13]||(a[13]=[L(" 编辑 ",-1)])),_:2,__:[13]},1032,["onClick"])):Q("",!0),I(qe,{trigger:"click",onCommand:Le},{dropdown:N(()=>[I(ae,null,{default:N(()=>[I(ee,{command:{action:"duplicate",quote:e},icon:"DocumentCopy"},{default:N(()=>a[14]||(a[14]=[L(" 复制 ",-1)])),_:2,__:[14]},1032,["command"]),I(ee,{command:{action:"pdf",quote:e},icon:"Download"},{default:N(()=>a[15]||(a[15]=[L(" 导出PDF ",-1)])),_:2,__:[15]},1032,["command"]),Te(e)?(Z(),M(ee,{key:0,command:{action:"delete",quote:e},icon:"Delete",divided:""},{default:N(()=>a[16]||(a[16]=[L(" 删除 ",-1)])),_:2,__:[16]},1032,["command"])):Q("",!0)]),_:2},1024)]),default:N(()=>[I(l,{size:"small",type:"info",icon:"MoreFilled"})]),_:2},1024)])];var t}),_:1})]),_:1},8,["data"])),[[Re,ge.value]]),B("div",fe,[I(He,{"current-page":be.value,"onUpdate:currentPage":a[7]||(a[7]=e=>be.value=e),"page-size":we.value,total:he.value,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:Ne,onSizeChange:Ee},null,8,["current-page","page-size","total"])])]),_:1}),ge.value||0!==ye.value.length||je.value?Q("",!0):(Z(),M(Je,{key:0,description:"还没有创建报价单","image-size":200},{default:N(()=>a[17]||(a[17]=[B("p",null,"创建您的第一个报价单开始使用",-1)])),extra:N(()=>[I(o,{to:"/quotes/create"},{default:N(()=>[I(l,{type:"primary"},{default:N(()=>a[18]||(a[18]=[L("创建报价",-1)])),_:1,__:[18]})]),_:1})]),_:1})),!ge.value&&0===ye.value.length&&je.value?(Z(),M(Je,{key:1,description:"没有找到符合条件的报价单","image-size":160},{extra:N(()=>[I(l,{onClick:Be},{default:N(()=>a[19]||(a[19]=[L("清除筛选",-1)])),_:1,__:[19]})]),_:1})):Q("",!0)])}}});export{ve as _};
