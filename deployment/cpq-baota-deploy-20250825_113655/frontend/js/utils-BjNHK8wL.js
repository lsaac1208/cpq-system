var t=Object.defineProperty,e=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,a=(e,n,i)=>n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[n]=i,r=(t,r)=>{for(var o in r||(r={}))n.call(r,o)&&a(t,o,r[o]);if(e)for(var o of e(r))i.call(r,o)&&a(t,o,r[o]);return t},o=(t,e,n)=>a(t,"symbol"!=typeof e?e+"":e,n),s=(t,e,n)=>new Promise((i,a)=>{var r=t=>{try{s(n.next(t))}catch(e){a(e)}},o=t=>{try{s(n.throw(t))}catch(e){a(e)}},s=t=>t.done?i(t.value):Promise.resolve(t.value).then(r,o);s((n=n.apply(t,e)).next())});import{b1 as l}from"./element-plus-DR0qywX_.js";import{r as h,f as c,P as d}from"./vendor-pdf-BGK3fMt2.js";import{y as u}from"./api-BHu6TLr6.js";const g={success:t=>{l({message:t,type:"success"})},error:t=>{l({message:t,type:"error"})},warning:t=>{l({message:t,type:"warning"})},info:t=>{l({message:t,type:"info"})}},m=class t{constructor(){o(this,"worker")}static getInstance(){return t.instance||(t.instance=new t),t.instance}compressImage(t){return s(this,arguments,function*(t,e={},n){const i=r({maxWidth:1920,maxHeight:1920,quality:.85,maxSizeMB:2,format:"jpeg",enableWebWorker:!0},e);if(null==n||n(0,"开始处理图片"),!this.isValidImageFile(t))throw new Error("不支持的文件格式");null==n||n(10,"读取图片数据");const a=yield this.loadImage(t);null==n||n(25,"计算压缩参数");const{targetWidth:o,targetHeight:s}=this.calculateTargetSize(a.width,a.height,i.maxWidth,i.maxHeight);null==n||n(40,"开始压缩图片");const l=yield this.compressWithCanvas(a,o,s,i.quality,i.format,t=>null==n?void 0:n(40+.5*t,"压缩中"));null==n||n(90,"优化文件大小");let h=l;return l.size>1024*i.maxSizeMB*1024&&(h=yield this.secondaryCompression(a,o,s,i,t=>null==n?void 0:n(90+.1*t,"深度压缩"))),null==n||n(100,"压缩完成"),{file:new File([h],this.generateCompressedFileName(t.name,i.format),{type:h.type}),originalSize:t.size,compressedSize:h.size,compressionRatio:(t.size-h.size)/t.size*100,width:o,height:s,format:i.format}})}isValidImageFile(t){return["image/jpeg","image/jpg","image/png","image/webp","image/gif"].includes(t.type)}loadImage(t){return new Promise((e,n)=>{const i=new Image;i.onload=()=>e(i),i.onerror=()=>n(new Error("图片加载失败")),i.src=URL.createObjectURL(t)})}calculateTargetSize(t,e,n,i){let a=t,r=e;const o=n/t,s=i/e,l=Math.min(o,s,1);return a=Math.round(t*l),r=Math.round(e*l),{targetWidth:a,targetHeight:r}}compressWithCanvas(t,e,n,i,a,r){return new Promise((o,s)=>{try{const l=document.createElement("canvas"),h=l.getContext("2d");if(!h)throw new Error("无法创建Canvas上下文");l.width=e,l.height=n,null==r||r(.2),h.imageSmoothingEnabled=!0,h.imageSmoothingQuality="high",null==r||r(.5),h.drawImage(t,0,0,e,n),null==r||r(.8),l.toBlob(t=>{t?o(t):s(new Error("图片压缩失败"))},this.getMimeType(a),i),null==r||r(1)}catch(l){s(l)}})}secondaryCompression(t,e,n,i,a){return s(this,null,function*(){const r=Math.round(.8*e),o=Math.round(.8*n),s=Math.max(.6,.8*i.quality);return this.compressWithCanvas(t,r,o,s,"jpeg",a)})}getMimeType(t){switch(t){case"jpeg":default:return"image/jpeg";case"webp":return"image/webp";case"png":return"image/png"}}generateCompressedFileName(t,e){const n=t.replace(/\.[^/.]+$/,""),i="jpeg"===e?"jpg":e;return"".concat(n,"_compressed.").concat(i)}};o(m,"instance");const f=m.getInstance();function p(t,e,n){return s(this,null,function*(){return f.compressImage(t,e,n)})}const x={highQuality:{maxWidth:2048,maxHeight:2048,quality:.9,maxSizeMB:3,format:"jpeg"},standard:{maxWidth:1920,maxHeight:1920,quality:.85,maxSizeMB:2,format:"jpeg"},fast:{maxWidth:1280,maxHeight:1280,quality:.8,maxSizeMB:1,format:"jpeg"},thumbnail:{maxWidth:400,maxHeight:400,quality:.8,maxSizeMB:.2,format:"jpeg"}};class w{constructor(){o(this,"pageWidth",595.28),o(this,"margin",50),o(this,"padding",8)}calculateTextWidth(t,e,n){return e.widthOfTextAtSize(t,n)}wrapText(t,e,n,i){const a=[];let r="";for(let o=0;o<t.length;o++){const s=t[o],l=r+s;this.calculateTextWidth(l,e,n)>i&&r.length>0?(a.push(r.trim()),r=s):r=l}return r.length>0&&a.push(r.trim()),a.length>0?a:[""]}calculateCellHeight(t,e,n,i,a=1.2){const r=t.fontSize||i,o=n-2*this.padding;if(""===t.text.trim())return i+2*this.padding;const s=this.wrapText(t.text,e,r,o);return r*Math.max(1,s.length)*a+2*this.padding}calculateColumnWidths(t,e,n,i,a){t.reduce((t,e)=>t+(e.weight||1),0);const r=t.map(t=>t.minWidth||50),o=t.map(t=>t.maxWidth||200),s=t.map((t,a)=>{let r=0;const o=this.calculateTextWidth(t.header,n,i);return r=Math.max(r,o),e.forEach(t=>{if(t[a]){const e=t[a],o=this.calculateTextWidth(e.text,n,e.fontSize||i);r=Math.max(r,o)}}),r+2*this.padding});let l=a,h=t.map((t,e)=>({index:e,weight:t.weight||1,minWidth:Math.max(r[e],s[e]),maxWidth:o[e]}));const c=new Array(t.length).fill(0);if(h.forEach(t=>{const e=Math.min(t.minWidth,l);c[t.index]=e,l-=e}),l>0){const t=h.reduce((t,e)=>t+(e.maxWidth>c[e.index]?e.weight:0),0);t>0&&h.forEach(e=>{if(e.maxWidth>c[e.index]){const n=Math.min(l*(e.weight/t),e.maxWidth-c[e.index]);c[e.index]+=n,l-=n}})}return c}drawTable(t,e,n,i){const{columns:a,data:r,header:o=!0,borderColor:s=[.3,.3,.3],borderWidth:l=1,headerBackgroundColor:h=[.9,.9,.9],alternateRowColor:c=[.98,.98,.98],fontSize:d=10,padding:u=8}=e;this.padding=u;const g=this.pageWidth-2*this.margin,m=this.calculateColumnWidths(a,r,n.regular,d,g),f=r.map(t=>{let e=0;return t.forEach((t,i)=>{const a=this.calculateCellHeight(t,n.regular,m[i],d);e=Math.max(e,a)}),e}),p=o?this.calculateCellHeight({text:a[0].header},n.bold,m[0],d):0,x=p+f.reduce((t,e)=>t+e,0);let w=i;return this.drawTableBackground(t,this.margin,w-x,g,x),o&&(this.drawTableHeaderBackground(t,a,m,p,h,w),w-=p),f.forEach((e,n)=>{const i=n%2==1?c:[1,1,1];this.drawTableRowBackground(t,m,e,i,w),w-=e}),this.drawCompleteTableBorder(t,this.margin,i-x,g,x,s,l),this.drawColumnSeparators(t,this.margin,i-x,i,m,s,l),this.drawRowSeparators(t,this.margin,i-x,m,f,p,s,l),o&&(w=i-p,this.drawTableHeaderText(t,a,m,p,n.bold,w)),w=i-p,f.forEach((e,i)=>{this.drawTableRowText(t,r[i],m,e,n.regular,w),w-=e}),i-x}drawTableBackground(t,e,n,i,a){t.drawRectangle({x:e,y:n,width:i,height:a,color:h(1,1,1)})}drawTableHeaderBackground(t,e,n,i,a,r){t.drawRectangle({x:this.margin,y:r-i,width:n.reduce((t,e)=>t+e,0),height:i,color:h(a[0],a[1],a[2])})}drawTableHeaderText(t,e,n,i,a,r){let o=this.margin;e.forEach((e,s)=>{const l=e.headerAlign||e.align||"center";this.drawTextInCell(t,e.header,o,r-i,n[s],i,a,10,l,"middle",h(.1,.1,.1)),o+=n[s]})}drawTableRowBackground(t,e,n,i,a){t.drawRectangle({x:this.margin,y:a-n,width:e.reduce((t,e)=>t+e,0),height:n,color:h(i[0],i[1],i[2])})}drawTableRowText(t,e,n,i,a,r){let o=this.margin;e.forEach((e,s)=>{var l,c,d;s<n.length&&(this.drawTextInCell(t,e.text,o,r-i,n[s],i,a,e.fontSize||10,e.align||"left","top",h((null==(l=e.color)?void 0:l[0])||.2,(null==(c=e.color)?void 0:c[1])||.2,(null==(d=e.color)?void 0:d[2])||.2)),o+=n[s])})}drawTextInCell(t,e,n,i,a,r,o,s,l,h,c){const d=a-2*this.padding,u=this.wrapText(e,o,s,d),g=1.2*s,m=u.length*g;let f=i+this.padding;"middle"===h?f=i+(r-m)/2:"bottom"===h&&(f=i+r-m-this.padding),u.forEach((e,i)=>{const r=this.calculateTextWidth(e,o,s);let h=n+this.padding;"center"===l?h=n+(a-r)/2:"right"===l&&(h=n+a-r-this.padding);const d=f+i*g+.85*s;t.drawText(e,{x:h,y:d,size:s,font:o,color:c})})}drawCompleteTableBorder(t,e,n,i,a,r,o){t.drawRectangle({x:e,y:n,width:i,height:a,borderColor:h(r[0],r[1],r[2]),borderWidth:Math.max(.5,o)})}drawColumnSeparators(t,e,n,i,a,r,o){let s=e;const l=a.reduce((t,e)=>t+e,0);for(let h=0;h<a.length-1;h++)s+=a[h],s<e+l&&this.drawVerticalLine(t,s,n,i,r,Math.max(.5,o))}drawRowSeparators(t,e,n,i,a,r,o,s){const l=i.reduce((t,e)=>t+e,0);let h=n-r;r>0&&this.drawHorizontalLine(t,e,e+l,h,o,Math.max(.5,s));for(let c=0;c<a.length-1;c++)h-=a[c],this.drawHorizontalLine(t,e,e+l,h,o,Math.max(.5,s))}drawTableBorder(t,e,n,i,a,r,o){t.drawRectangle({x:e,y:n,width:i,height:a,borderColor:h(r[0],r[1],r[2]),borderWidth:o})}drawVerticalLine(t,e,n,i,a,r){const o=Math.min(n,i),s=Math.max(n,i);t.drawLine({start:{x:e,y:o},end:{x:e,y:s},thickness:Math.max(.5,r),color:h(a[0],a[1],a[2])})}drawHorizontalLine(t,e,n,i,a,r){const o=Math.min(e,n),s=Math.max(e,n);t.drawLine({start:{x:o,y:i},end:{x:s,y:i},thickness:Math.max(.5,r),color:h(a[0],a[1],a[2])})}}const y=new w,b=class t{constructor(){o(this,"settings",null),o(this,"lastFetch",null),o(this,"CACHE_DURATION",3e5)}static getInstance(){return t.instance||(t.instance=new t),t.instance}getSettings(t=!1){return s(this,null,function*(){const e=new Date;if(t||!this.settings||!this.lastFetch||e.getTime()-this.lastFetch.getTime()>this.CACHE_DURATION)try{this.settings=yield u.getSettings(t),this.lastFetch=e}catch(n){if(!this.settings)throw n}return this.settings})}getCompanyInfoForPDF(){return s(this,null,function*(){try{return(yield this.getSettings()).company_info}catch(t){return this.getDefaultCompanyInfo()}})}getSystemConfig(){return s(this,null,function*(){return(yield this.getSettings()).system_config})}getPDFSettings(){return s(this,null,function*(){return(yield this.getSettings()).pdf_settings})}getEmailSettings(){return s(this,null,function*(){return(yield this.getSettings()).email_settings})}getBusinessRules(){return s(this,null,function*(){return(yield this.getSettings()).business_rules})}clearCache(){this.settings=null,this.lastFetch=null,u.clearCache()}updateCache(t){this.settings=t,this.lastFetch=new Date}getDefaultCompanyInfo(){return{name:"您的公司名称",address:"请在系统设置中配置公司地址",phone:"+86 xxx-xxxx-xxxx",email:"info@yourcompany.com",website:"www.yourcompany.com",tax_number:"请配置税号"}}};o(b,"instance");const T=b.getInstance(),S=class t{constructor(){o(this,"pageWidth",595.28),o(this,"pageHeight",841.89),o(this,"margin",50),o(this,"fontSize",{title:24,heading:18,subheading:14,normal:12,small:10}),o(this,"chineseFont",null),o(this,"fallbackFont",null)}loadChineseFont(e){return s(this,null,function*(){try{e.registerFontkit(c);let a=t.fontCache.get("chinese-font");if(!a){const e=["/fonts/NotoSansSC-Regular.ttf","https://fonts.gstatic.com/s/notosanssc/v36/k3kCo84MPvpLmixcA63oeAL7Iqp5IZJF9bmaG9_FnYxNbPzS5HE.ttf","https://cdn.jsdelivr.net/npm/@expo-google-fonts/noto-sans-sc@0.2.2/NotoSansSC_400Regular.ttf"];for(const i of e)try{const e=yield fetch(i);if(e.ok){if(a=yield e.arrayBuffer(),a&&a.byteLength>1e5){t.fontCache.set("chinese-font",a);break}a=null}}catch(n){}}if(a)try{return this.chineseFont=yield e.embedFont(a),{regularFont:this.chineseFont,boldFont:this.chineseFont}}catch(i){}const r=yield e.embedFont("Helvetica"),o=yield e.embedFont("Helvetica-Bold");return this.fallbackFont=r,{regularFont:r,boldFont:o}}catch(n){throw new Error("无法加载任何字体，PDF生成失败")}})}renderText(t,e,n,i,a){try{t.drawText(e,r({x:n,y:i},a))}catch(o){try{const o=this.sanitizeText(e);return void t.drawText(o,r({x:n,y:i},a))}catch(s){}try{const o=this.translateChineseToEnglish(e);return void t.drawText(o,r({x:n,y:i},a))}catch(l){}try{t.drawText("[Chinese Text]",r({x:n,y:i},a))}catch(h){}}}sanitizeText(t){return t.replace(/[\u0000-\u001F\u007F-\u009F]/g,"").replace(/\uFFFD/g,"?")}translateChineseToEnglish(t){let e=t;return Object.entries({"电力设备制造有限公司":"Power Equipment Manufacturing Co., Ltd.","报价单":"Quotation","产品报价单":"Product Quotation","报价单号":"Quote No.","日期":"Date","有效期至":"Valid Until","客户信息":"Customer Information","客户姓名":"Customer Name","公司名称":"Company Name","联系邮箱":"Email","联系电话":"Phone","联系地址":"Address","邮箱":"Email","电话":"Phone","地址":"Address","产品名称":"Product","产品":"Product","产品描述":"Description","描述":"Description","数量":"Quantity","单价":"Unit Price","折扣":"Discount","小计":"Subtotal","税费":"Tax","总计":"Total","条款和条件":"Terms and Conditions","本报价单由":"Generated by","提供":"","高压变压器":"HV Transformer","配电柜":"Distribution Cabinet","电缆":"Cable","张三":"Zhang San","上海工业发展有限公司":"Shanghai Industrial Development Co., Ltd.","上海市":"Shanghai","中国":"China","人民币":"RMB","元":"Yuan"}).forEach(([t,n])=>{e=e.replace(new RegExp(t,"g"),n)}),/[\u4e00-\u9fff]/.test(e)&&(e="[CN] ".concat(e)),e}generateQuotePDF(t){return s(this,null,function*(){try{const e=yield d.create(),n=e.addPage([this.pageWidth,this.pageHeight]),i=yield this.loadChineseFont(e);let a=this.pageHeight-this.margin;return a=this.addCompanyHeader(n,i,t.company_info,a),a=this.addQuoteHeader(n,i,t.quote,a),a=this.addCustomerInfo(n,i,t.customer_info,a),a=this.addLineItemsTable(n,i,t.line_items,a),a=this.addTotals(n,i,t.totals,a),t.quote.terms_conditions&&(a=this.addTermsAndConditions(n,i,t.quote.terms_conditions,a)),this.addFooter(n,i,t.company_info),yield e.save()}catch(e){throw new Error("PDF生成失败: ".concat(e.message))}})}downloadPDF(t,e){return s(this,null,function*(){try{const n=yield this.generateQuotePDF(t),i=new Blob([n],{type:"application/pdf"}),a=URL.createObjectURL(i),r=document.createElement("a");r.href=a,r.download=e||"报价单-".concat(t.quote.quote_number,".pdf"),document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a)}catch(n){throw n}})}testChineseSupport(){return s(this,null,function*(){try{const t=yield d.create(),e=yield this.loadChineseFont(t);if(e.regularFont){const n=t.addPage([200,100]);return this.renderText(n,"测试中文",10,50,{size:12,font:e.regularFont,color:h(0,0,0)}),yield t.save(),!0}return!1}catch(t){return!1}})}addCompanyHeader(t,e,n,i){let a=i;const r=n.name||"电力设备制造有限公司",o=this.getTextWidth(r,this.fontSize.title);if(this.renderText(t,r,this.pageWidth/2-o/2,a,{size:this.fontSize.title,font:e.boldFont,color:h(.1,.1,.1)}),a-=35,n.address){const i=this.getTextWidth(n.address,this.fontSize.normal);this.renderText(t,n.address,this.pageWidth/2-i/2,a,{size:this.fontSize.normal,font:e.regularFont,color:h(.3,.3,.3)}),a-=25}const s=[];if(n.phone&&s.push("电话: ".concat(n.phone)),n.email&&s.push("邮箱: ".concat(n.email)),n.website&&s.push("网站: ".concat(n.website)),s.length>0){const n=s.join(" | "),i=this.getTextWidth(n,this.fontSize.small);this.renderText(t,n,this.pageWidth/2-i/2,a,{size:this.fontSize.small,font:e.regularFont,color:h(.4,.4,.4)}),a-=20}return t.drawLine({start:{x:this.margin,y:a},end:{x:this.pageWidth-this.margin,y:a},thickness:2,color:h(.2,.2,.2)}),a-=30,a}addQuoteHeader(t,e,n,i){let a=i;this.renderText(t,"产品报价单",this.margin,a,{size:this.fontSize.heading,font:e.boldFont,color:h(.1,.1,.1)});const r="报价单号: ".concat(n.quote_number),o=this.getTextWidth(r,this.fontSize.normal);this.renderText(t,r,this.pageWidth-this.margin-o,a,{size:this.fontSize.normal,font:e.regularFont,color:h(.2,.2,.2)}),a-=25;const s=new Date(n.created_at).toLocaleDateString("zh-CN"),l="日期: ".concat(s),c=this.getTextWidth(l,this.fontSize.normal);if(this.renderText(t,l,this.pageWidth-this.margin-c,a,{size:this.fontSize.normal,font:e.regularFont,color:h(.2,.2,.2)}),a-=20,n.valid_until){const i=new Date(n.valid_until).toLocaleDateString("zh-CN"),r="有效期至: ".concat(i),o=this.getTextWidth(r,this.fontSize.normal);this.renderText(t,r,this.pageWidth-this.margin-o,a,{size:this.fontSize.normal,font:e.regularFont,color:h(.6,.2,.2)}),a-=20}return a-=15,a}addCustomerInfo(t,e,n,i){let a=i;return this.renderText(t,"客户信息",this.margin,a,{size:this.fontSize.subheading,font:e.boldFont,color:h(.1,.1,.1)}),a-=25,[{label:"客户姓名",value:n.name},{label:"公司名称",value:n.company},{label:"联系邮箱",value:n.email},{label:"联系电话",value:n.phone},{label:"联系地址",value:n.address}].forEach(n=>{if(n.value){const i="".concat(n.label,": ").concat(n.value);this.renderText(t,i,this.margin,a,{size:this.fontSize.normal,font:e.regularFont,color:h(.2,.2,.2)}),a-=18}}),a-=15,a}addLineItemsTable(t,e,n,i){const a={columns:[{header:"产品名称",weight:2,align:"left",headerAlign:"center",minWidth:80,maxWidth:120},{header:"产品描述",weight:4,align:"left",headerAlign:"center",minWidth:150,maxWidth:200,wrap:!0},{header:"数量",weight:1,align:"right",headerAlign:"center",minWidth:40,maxWidth:60},{header:"单价 (¥)",weight:1.5,align:"right",headerAlign:"center",minWidth:60,maxWidth:80},{header:"折扣",weight:1,align:"center",headerAlign:"center",minWidth:40,maxWidth:60},{header:"小计 (¥)",weight:1.5,align:"right",headerAlign:"center",minWidth:60,maxWidth:80}],data:n.map(t=>[{text:t.product_name||"",align:"left"},{text:t.description||"",align:"left",wrap:!0},{text:String(t.quantity||0),align:"right"},{text:this.formatCurrency(t.unit_price||0),align:"right"},{text:t.discount_percentage?"".concat(t.discount_percentage,"%"):"-",align:"center",color:[.6,.3,.3]},{text:this.formatCurrency(t.line_total||0),align:"right",color:[.1,.1,.1]}]),header:!0,borderColor:[.3,.3,.3],borderWidth:1,headerBackgroundColor:[.9,.9,.9],alternateRowColor:[.98,.98,.98],fontSize:9,padding:6};return y.drawTable(t,a,{regular:e.regularFont,bold:e.boldFont},i)}formatCurrency(t){return t>=1e6?"".concat((t/1e6).toFixed(1),"M"):t>=1e3?"".concat((t/1e3).toFixed(0),"k"):t.toLocaleString()}addTotals(t,e,n,i){let a=i;const r=this.pageWidth-this.margin,o=r-200;this.renderText(t,"小计:",o,a,{size:this.fontSize.normal,font:e.regularFont,color:h(.2,.2,.2)});const s=Number(n.subtotal||0),l="¥".concat(s.toLocaleString()),c=this.getTextWidth(l,this.fontSize.normal);if(this.renderText(t,l,r-c,a,{size:this.fontSize.normal,font:e.regularFont,color:h(.2,.2,.2)}),a-=25,n.discount_amount>0){this.renderText(t,"折扣:",o,a,{size:this.fontSize.normal,font:e.regularFont,color:h(.2,.2,.2)});const i="¥".concat(Number(n.discount_amount).toLocaleString()),s=this.getTextWidth(i,this.fontSize.normal);this.renderText(t,i,r-s,a,{size:this.fontSize.normal,font:e.regularFont,color:h(.8,.2,.2)}),a-=25}if(n.tax_amount>0){this.renderText(t,"税费:",o,a,{size:this.fontSize.normal,font:e.regularFont,color:h(.2,.2,.2)});const i="¥".concat(Number(n.tax_amount).toLocaleString()),s=this.getTextWidth(i,this.fontSize.normal);this.renderText(t,i,r-s,a,{size:this.fontSize.normal,font:e.regularFont,color:h(.2,.2,.2)}),a-=25}t.drawLine({start:{x:o,y:a+5},end:{x:r,y:a+5},thickness:1,color:h(.3,.3,.3)}),a-=15,this.renderText(t,"总计:",o,a,{size:this.fontSize.heading,font:e.boldFont,color:h(.1,.1,.1)});const d="¥".concat(Number(n.total||0).toLocaleString()),u=this.getTextWidth(d,this.fontSize.heading);return this.renderText(t,d,r-u,a,{size:this.fontSize.heading,font:e.boldFont,color:h(.8,.2,.2)}),a-=40,a}addTermsAndConditions(t,e,n,i){let a=i;this.renderText(t,"条款和条件",this.margin,a,{size:this.fontSize.subheading,font:e.boldFont,color:h(.1,.1,.1)}),a-=25;const r=this.pageWidth-2*this.margin;return this.wrapText(n,this.fontSize.small,r).forEach(n=>{this.renderText(t,n,this.margin,a,{size:this.fontSize.small,font:e.regularFont,color:h(.3,.3,.3)}),a-=18}),a-=15,a}addFooter(t,e,n){const i=this.margin-10,a=this.pageWidth/2,r="本报价单由 ".concat(n.name||"本公司"," 提供"),o=this.getTextWidth(r,this.fontSize.small);this.renderText(t,r,a-o/2,i,{size:this.fontSize.small,font:e.regularFont,color:h(.5,.5,.5)})}getTextWidth(t,e){let n=0;for(let i=0;i<t.length;i++){const a=t.charAt(i);/[\u4e00-\u9fff]/.test(a)?n+=.9*e:/[A-Z]/.test(a)?n+=.7*e:n+=.5*e}return n}wrapText(t,e,n){const i=[],a=t.split("");let r="";for(const o of a){const t=r+o;this.getTextWidth(t,e)>n&&r.length>0?(i.push(r),r=o):r=t}return r.length>0&&i.push(r),i}};o(S,"fontCache",new Map);const z=new S,C={name:"电力设备制造有限公司",address:"中国上海市浦东新区张江高科技园区科苑路001号",phone:"+86 21 1234-5678",email:"info@powerequipment.com.cn",website:"www.powerequipment.com.cn",tax_number:"91310000123456789X"};function F(t,e){var n;return{quote:t,company_info:e||C,customer_info:{name:t.customer_name,company:t.customer_company,email:t.customer_email,phone:t.customer_phone,address:t.customer_address},line_items:(null==(n=t.items)?void 0:n.map(t=>{var e,n,i,a;return{product_code:(null==(e=t.product)?void 0:e.code)||"",product_name:(null==(n=t.product)?void 0:n.name)||"",description:null==(i=t.product)?void 0:i.description,quantity:t.quantity,unit_price:t.unit_price,discount_percentage:t.discount_percentage,discount_amount:t.discount_amount,line_total:t.line_total,specifications:null==(a=t.product)?void 0:a.specifications}}))||[],totals:{subtotal:t.subtotal||0,discount_amount:t.discount_amount||0,tax_amount:t.tax_amount||0,total:t.total_price||0}}}function W(t){return s(this,null,function*(){try{const e=yield T.getCompanyInfoForPDF();return F(t,e)}catch(e){return F(t)}})}const _=class t{constructor(){o(this,"pageWidth",595.28),o(this,"pageHeight",841.89),o(this,"margin",50),o(this,"fontSize",{title:24,heading:18,subheading:14,normal:12,small:10}),o(this,"regularFont",null),o(this,"boldFont",null)}loadChineseFont(e){return s(this,null,function*(){try{let i=t.fontCache.get("NotoSansSC-Regular");if(!i){const e=["/fonts/NotoSansSC-Regular.ttf","https://fonts.gstatic.com/s/notosanssc/v36/k3kCo84MPvpLmixcA63oeAL7Iqp5IZJF9bmaG9_FnYxNbPzS5HE.ttf"];for(const a of e)try{const e=yield fetch(a);if(e.ok){if(i=yield e.arrayBuffer(),i.byteLength>5e4){t.fontCache.set("NotoSansSC-Regular",i);break}i=null}}catch(n){i=null}if(!i)throw new Error("无法加载任何中文字体文件")}return this.regularFont=yield e.embedFont(i),this.boldFont=this.regularFont,{regular:this.regularFont,bold:this.boldFont}}catch(n){throw new Error("中文字体加载失败，PDF生成将无法正确显示中文")}})}generateProductCatalogPDF(t){return s(this,null,function*(){try{const e=yield d.create();e.registerFontkit(c);const n=yield this.loadChineseFont(e),i=new w;let a=e.addPage([this.pageWidth,this.pageHeight]),r=this.pageHeight-this.margin;return r=yield this.addCompanyHeader(a,n,r),r=yield this.addCatalogHeader(a,n,t.length,r),r=yield this.addCategorySummary(a,n,t,r),r=yield this.addProductTable(a,n,t,i,r),yield e.save()}catch(e){throw new Error("产品目录PDF生成失败: ".concat(e.message))}})}addCompanyHeader(t,e,n){return s(this,null,function*(){let i=n;const a=C.name||"电力设备制造有限公司",r=this.getTextWidth(a,this.fontSize.title);if(t.drawText(a,{x:this.pageWidth/2-r/2,y:i,size:this.fontSize.title,font:e.bold,color:h(.1,.1,.1)}),i-=35,C.address){const n=this.getTextWidth(C.address,this.fontSize.normal);t.drawText(C.address,{x:this.pageWidth/2-n/2,y:i,size:this.fontSize.normal,font:e.regular,color:h(.3,.3,.3)}),i-=25}const o=[];if(C.phone&&o.push("电话: ".concat(C.phone)),C.email&&o.push("邮箱: ".concat(C.email)),C.website&&o.push("网站: ".concat(C.website)),o.length>0){const n=o.join(" | "),a=this.getTextWidth(n,this.fontSize.small);t.drawText(n,{x:this.pageWidth/2-a/2,y:i,size:this.fontSize.small,font:e.regular,color:h(.4,.4,.4)}),i-=20}return t.drawLine({start:{x:this.margin,y:i},end:{x:this.pageWidth-this.margin,y:i},thickness:2,color:h(.2,.2,.2)}),i-=30,i})}addCatalogHeader(t,e,n,i){return s(this,null,function*(){let a=i;t.drawText("产品目录",{x:this.margin,y:a,size:this.fontSize.heading,font:e.bold,color:h(.1,.1,.1)});const r="生成日期: ".concat((new Date).toLocaleDateString("zh-CN")," | 产品总数: ").concat(n),o=this.getTextWidth(r,this.fontSize.normal);return t.drawText(r,{x:this.pageWidth-this.margin-o,y:a,size:this.fontSize.normal,font:e.regular,color:h(.2,.2,.2)}),a-=40,a})}addCategorySummary(t,e,n,i){return s(this,null,function*(){let a=i;const r=new Map;n.forEach(t=>{const e=t.category||"未分类";r.set(e,(r.get(e)||0)+1)}),t.drawText("分类统计",{x:this.margin,y:a,size:this.fontSize.subheading,font:e.bold,color:h(.1,.1,.1)}),a-=25;const o=Array.from(r.entries()).map(([t,e])=>"".concat(t,": ").concat(e,"个产品")).join(" | "),s=this.getTextWidth(o,this.fontSize.normal);return t.drawText(o,{x:this.pageWidth/2-s/2,y:a,size:this.fontSize.normal,font:e.regular,color:h(.3,.3,.3)}),a-=40,a})}addProductTable(t,e,n,i,a){return s(this,null,function*(){const r={columns:[{header:"产品代码",width:80,align:"center"},{header:"产品名称",width:120,align:"left"},{header:"分类",width:80,align:"center"},{header:"基础价格",width:80,align:"right"},{header:"产品类型",width:70,align:"center"},{header:"状态",width:60,align:"center"},{header:"描述",width:120,align:"left"}],data:n.map(t=>{var e;return[{text:t.code||"",align:"center"},{text:t.name||"",align:"left"},{text:t.category||"",align:"center"},{text:"$".concat((null==(e=t.base_price)?void 0:e.toLocaleString())||"0"),align:"right"},{text:t.is_configurable?"可配置":"标准",align:"center"},{text:t.is_active?"活跃":"非活跃",align:"center"},{text:t.description||"",align:"left"}]}),header:!0,borderColor:[.3,.3,.3],borderWidth:1,headerBackgroundColor:[.9,.9,.9],alternateRowColor:[.98,.98,.98],fontSize:9,padding:6};return i.drawTable(t,r,e,a)})}getTextWidth(t,e){let n=0;for(let i=0;i<t.length;i++){const a=t.charAt(i);/[\u4e00-\u9fff]/.test(a)?n+=.9*e:/[A-Z]/.test(a)?n+=.7*e:n+=.5*e}return n}downloadProductCatalogPDF(t,e){return s(this,null,function*(){try{const n=yield this.generateProductCatalogPDF(t),i=new Blob([n],{type:"application/pdf"}),a=URL.createObjectURL(i),r=document.createElement("a");r.href=a,r.download=e||"产品目录-".concat((new Date).toLocaleDateString("zh-CN"),".pdf"),document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a)}catch(n){throw n}})}};o(_,"fontCache",new Map);const v=new _;function P(t){return s(this,null,function*(){yield v.downloadProductCatalogPDF(t)})}export{x as C,W as a,p as c,P as g,g as s,z as u};
