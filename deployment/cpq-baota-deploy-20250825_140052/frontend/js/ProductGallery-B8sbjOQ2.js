var vt=Object.defineProperty,jt=Object.defineProperties;var Gt=Object.getOwnPropertyDescriptors;var pt=Object.getOwnPropertySymbols;var Lt=Object.prototype.hasOwnProperty,Rt=Object.prototype.propertyIsEnumerable;var Ze=(N,h,g)=>h in N?vt(N,h,{enumerable:!0,configurable:!0,writable:!0,value:g}):N[h]=g,Ue=(N,h)=>{for(var g in h||(h={}))Lt.call(h,g)&&Ze(N,g,h[g]);if(pt)for(var g of pt(h))Rt.call(h,g)&&Ze(N,g,h[g]);return N},Ge=(N,h)=>jt(N,Gt(h)),l=(N,h)=>vt(N,"name",{value:h,configurable:!0});var Pe=(N,h,g)=>Ze(N,typeof h!="symbol"?h+"":h,g);var Y=(N,h,g)=>new Promise((p,U)=>{var k=$=>{try{d(g.next($))}catch(M){U(M)}},i=$=>{try{d(g.throw($))}catch(M){U(M)}},d=$=>$.done?p($.value):Promise.resolve($.value).then(k,i);d((g=g.apply(N,h)).next())});import{h as ie,s as F,_ as Oe}from"./index-CoBZUWE1.js";/* empty css                        *//* empty css                         */import{x as Ne,r as w,c as be,w as it,y as v,A as e,K as x,V as ae,D as oe,Q as t,I as n,M as D,u as y,O as f,z as r,P as Me,a6 as De,H as te,aD as mt,aE as Ot,j as st,J as Nt,n as _t,C as qt,aF as Jt}from"./vendor-vue-XfLkFKXI.js";import{d as qe,b as Je,a5 as Te,al as Be,l as Le,c as nt,V as Fe,as as yt,ax as rt,j as He,ae as Re,af as ht,M as Ht,N as Yt,ag as wt,X as bt,Y as $t,ah as kt,aD as ft,h as gt,aQ as It,ab as Kt,ac as Xt,a as Mt,ar as Qt,O as Zt,T as Pt,am as ea,aJ as Se,aR as lt,aS as Ct,aT as xt,ak as ta,W as aa,aB as sa,aU as la,aA as et,aV as tt,i as at,aW as oa,aX as ia,aa as na,aY as ra}from"./vendor-ui-CE-ZhXxH.js";/* empty css                *//* empty css                  */import"./el-form-item-l0sNRNKZ.js";/* empty css                 *//* empty css                 *//* empty css                    *//* empty css                *//* empty css                  *//* empty css                     *//* empty css                 *//* empty css                         *//* empty css               */const Ie=class Ie{constructor(){Pe(this,"worker")}static getInstance(){return Ie.instance||(Ie.instance=new Ie),Ie.instance}compressImage(U){return Y(this,arguments,function*(h,g={},p){const k=Ue({maxWidth:1920,maxHeight:1920,quality:.85,maxSizeMB:2,format:"jpeg",enableWebWorker:!0},g);if(p==null||p(0,"开始处理图片"),!this.isValidImageFile(h))throw new Error("不支持的文件格式");p==null||p(10,"读取图片数据");const i=yield this.loadImage(h);p==null||p(25,"计算压缩参数");const{targetWidth:d,targetHeight:$}=this.calculateTargetSize(i.width,i.height,k.maxWidth,k.maxHeight);p==null||p(40,"开始压缩图片");const M=yield this.compressWithCanvas(i,d,$,k.quality,k.format,q=>p==null?void 0:p(40+q*.5,"压缩中"));p==null||p(90,"优化文件大小");let V=M;return M.size>k.maxSizeMB*1024*1024&&(V=yield this.secondaryCompression(i,d,$,k,q=>p==null?void 0:p(90+q*.1,"深度压缩"))),p==null||p(100,"压缩完成"),{file:new File([V],this.generateCompressedFileName(h.name,k.format),{type:V.type}),originalSize:h.size,compressedSize:V.size,compressionRatio:(h.size-V.size)/h.size*100,width:d,height:$,format:k.format}})}isValidImageFile(h){return["image/jpeg","image/jpg","image/png","image/webp","image/gif"].includes(h.type)}loadImage(h){return new Promise((g,p)=>{const U=new Image;U.onload=()=>g(U),U.onerror=()=>p(new Error("图片加载失败")),U.src=URL.createObjectURL(h)})}calculateTargetSize(h,g,p,U){let k=h,i=g;const d=p/h,$=U/g,M=Math.min(d,$,1);return k=Math.round(h*M),i=Math.round(g*M),{targetWidth:k,targetHeight:i}}compressWithCanvas(h,g,p,U,k,i){return new Promise((d,$)=>{try{const M=document.createElement("canvas"),V=M.getContext("2d");if(!V)throw new Error("无法创建Canvas上下文");M.width=g,M.height=p,i==null||i(.2),V.imageSmoothingEnabled=!0,V.imageSmoothingQuality="high",i==null||i(.5),V.drawImage(h,0,0,g,p),i==null||i(.8),M.toBlob(A=>{A?d(A):$(new Error("图片压缩失败"))},this.getMimeType(k),U),i==null||i(1)}catch(M){$(M)}})}secondaryCompression(h,g,p,U,k){return Y(this,null,function*(){const i=Math.round(g*.8),d=Math.round(p*.8),$=Math.max(.6,U.quality*.8);return this.compressWithCanvas(h,i,d,$,"jpeg",k)})}getMimeType(h){switch(h){case"jpeg":return"image/jpeg";case"webp":return"image/webp";case"png":return"image/png";default:return"image/jpeg"}}generateCompressedFileName(h,g){const p=h.replace(/\.[^/.]+$/,""),U=g==="jpeg"?"jpg":g;return"".concat(p,"_compressed.").concat(U)}};l(Ie,"FastImageCompressor"),Pe(Ie,"instance");let ot=Ie;const ua=ot.getInstance();function zt(N,h,g){return Y(this,null,function*(){return ua.compressImage(N,h,g)})}l(zt,"compressImageFast");const Dt={highQuality:{maxWidth:2048,maxHeight:2048,quality:.9,maxSizeMB:3,format:"jpeg"},standard:{maxWidth:1920,maxHeight:1920,quality:.85,maxSizeMB:2,format:"jpeg"},fast:{maxWidth:1280,maxHeight:1280,quality:.8,maxSizeMB:1,format:"jpeg"},thumbnail:{maxWidth:400,maxHeight:400,quality:.8,maxSizeMB:.2,format:"jpeg"}},da={class:"fast-image-upload"},ca={class:"image-preview-area"},pa={key:0,class:"image-display"},va=["src","alt"],ma={class:"image-overlay"},_a={class:"overlay-actions"},fa={key:1,class:"uploading-state"},ga={class:"upload-progress"},ya={class:"upload-text"},ha={key:0,class:"processing-info"},wa={class:"processing-text"},ba={key:2,class:"empty-upload-area"},$a={key:0,class:"error-message"},ka={key:1,class:"compression-stats"},Ia={class:"stats-card"},Ma={class:"stats-header"},Ca={class:"stats-content"},xa={class:"stats-row"},za={class:"stats-value"},Da={class:"stats-row"},Ba={class:"stats-value compressed"},Fa={class:"stats-row"},Va={class:"stats-value"},Ea={class:"stats-row"},Ua={class:"stats-value"},Sa=Ne({__name:"FastImageUpload",props:{productId:{default:null},initialImageUrl:{default:""},imageAlt:{default:"产品图片"},maxSizeMB:{default:2},disabled:{type:Boolean,default:!1},compressionPreset:{default:"standard"}},emits:["upload-success","upload-error","delete-success","delete-error"],setup(N,{expose:h,emit:g}){const p=N,U=g,k=w(),i=w(p.initialImageUrl),d=w(!1),$=w(!1),M=w(0),V=w(!1),A=w(""),q=w(""),j=w(""),L=w(null),H=w(0),J=be(()=>Dt[p.compressionPreset]);it(()=>p.initialImageUrl,c=>{i.value=c},{immediate:!0});const ne=l(()=>M.value<30?"#409eff":(M.value<70,"#67c23a"),"getProgressColor"),re=l(c=>c?c.startsWith("data:")||c.startsWith("http://")||c.startsWith("https://")?c:c.startsWith("/api/v1")?"http://localhost:5173".concat(c):"http://localhost:5173/api/v1/products/uploads/".concat(c):"","getImageUrl"),ue=l(c=>["image/jpeg","image/jpg","image/png","image/webp"].includes(c.type)?c.size>10*1024*1024?(A.value="文件太大，请选择小于10MB的图片",!1):!0:(A.value="不支持的文件格式。请使用 JPG、PNG 或 WebP 格式",!1),"validateFile"),ce=l(c=>Y(this,null,function*(){var m,C,R,Z;if(ue(c)){d.value=!0,M.value=0,A.value="",j.value="",H.value=Date.now(),q.value="开始处理图片...";try{q.value="正在压缩图片...",M.value=10;const P=yield zt(c,J.value,(T,le)=>{M.value=10+T*.6,j.value=le});if(q.value="正在上传到服务器...",M.value=70,!p.productId){ee(P);return}const u=new FormData;u.append("image",P.file);const o="/products/".concat(p.productId,"/gallery/upload"),I=yield ie.post(o,u,{onUploadProgress:l(T=>{if(T.total){const le=T.loaded/T.total*100;M.value=70+le*.3}},"onUploadProgress")});if(M.value=100,q.value="上传完成！",I){const T=Date.now()-H.value,le=((m=I.image)==null?void 0:m.image_url)||I.image_url||((C=I.upload_info)==null?void 0:C.image_url);if(le){i.value=le,L.value=Ge(Ue({},P),{processingTime:T});const ye="图片上传成功！压缩".concat(P.compressionRatio.toFixed(1),"%，耗时").concat(T,"ms");F.success(ye),U("upload-success",le,Ge(Ue({},I),{compressionStats:L.value}))}else throw new Error("上传响应中未找到图片URL")}else throw new Error("上传响应为空")}catch(P){const u=((Z=(R=P.response)==null?void 0:R.data)==null?void 0:Z.error)||P.message||"图片处理或上传失败";A.value=u,U("upload-error",u),F.error("上传失败: ".concat(u))}finally{d.value=!1,M.value=0,q.value="",j.value="",setTimeout(()=>{d.value||(q.value="")},2e3)}}}),"uploadFile"),ee=l(c=>{const m=new FileReader;m.onload=C=>{var Z;i.value=(Z=C.target)==null?void 0:Z.result;const R=Date.now()-H.value;L.value=Ge(Ue({},c),{processingTime:R}),d.value=!1,M.value=0,F.success("图片预览就绪！压缩".concat(c.compressionRatio.toFixed(1),"%"))},m.readAsDataURL(c.file)},"handleLocalPreview"),Q=l(()=>Y(this,null,function*(){var c,m;if(!(!p.productId||!i.value))try{yield Re.confirm("确定要删除这张图片吗？删除后无法恢复。","确认删除",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning",confirmButtonClass:"el-button--danger"}),$.value=!0,yield ie.delete("/products/".concat(p.productId,"/delete-image")),i.value="",L.value=null,A.value="",F.success("图片删除成功"),U("delete-success")}catch(C){if(C!=="cancel"){const R=((m=(c=C.response)==null?void 0:c.data)==null?void 0:m.error)||"图片删除失败";A.value=R,U("delete-error",R),F.error(R)}}finally{$.value=!1}}),"deleteImage"),de=l(()=>{var c;p.disabled||d.value||(c=k.value)==null||c.click()},"triggerFileInput"),_e=l(c=>{var R;const m=c.target,C=(R=m.files)==null?void 0:R[0];C&&ce(C),m.value=""},"handleFileSelect"),fe=l(c=>{p.disabled||d.value||(c.preventDefault(),V.value=!0)},"handleDragOver"),S=l(()=>{V.value=!1},"handleDragLeave"),B=l(c=>{var C;if(p.disabled||d.value)return;c.preventDefault(),V.value=!1;const m=(C=c.dataTransfer)==null?void 0:C.files;m&&m.length>0&&ce(m[0])},"handleDrop"),_=l(c=>{const m=c.target;m.src="/images/default-product.svg"},"handleImageError"),W=l(c=>{if(c===0)return"0 B";const m=1024,C=["B","KB","MB","GB"],R=Math.floor(Math.log(c)/Math.log(m));return parseFloat((c/Math.pow(m,R)).toFixed(2))+" "+C[R]},"formatFileSize");return h({triggerUpload:de,deleteImage:Q,currentImageUrl:be(()=>i.value),isUploading:be(()=>d.value),compressionStats:be(()=>L.value)}),(c,m)=>{const C=Je,R=qe,Z=nt,P=yt,u=He;return r(),v("div",da,[e("div",ca,[e("div",{class:oe(["image-preview",{"has-image":i.value,"drag-over":V.value,uploading:d.value}]),onDragover:ae(fe,["prevent"]),onDragleave:ae(S,["prevent"]),onDrop:ae(B,["prevent"]),onClick:de},[i.value&&!d.value?(r(),v("div",pa,[e("img",{src:re(i.value),alt:c.imageAlt||"产品图片",class:"preview-image",onError:_},null,40,va),e("div",ma,[e("div",_a,[t(R,{type:"primary",size:"small",onClick:ae(de,["stop"])},{default:n(()=>[t(C,null,{default:n(()=>[t(y(Te))]),_:1}),m[1]||(m[1]=D(" 更换图片 ",-1))]),_:1,__:[1]}),t(R,{type:"danger",size:"small",onClick:ae(Q,["stop"]),disabled:$.value},{default:n(()=>[t(C,null,{default:n(()=>[t(y(Be))]),_:1}),m[2]||(m[2]=D(" 删除 ",-1))]),_:1,__:[2]},8,["disabled"])])])])):d.value?(r(),v("div",fa,[t(C,{class:"uploading-icon"},{default:n(()=>[t(y(Le))]),_:1}),e("div",ga,[t(Z,{percentage:M.value,"stroke-width":8,color:ne()},null,8,["percentage","color"])]),e("p",ya,f(q.value),1),j.value?(r(),v("div",ha,[e("p",wa,f(j.value),1)])):x("",!0)])):(r(),v("div",ba,[t(C,{class:"upload-icon",size:"48"},{default:n(()=>[t(y(Fe))]),_:1}),m[3]||(m[3]=e("div",{class:"upload-hint"},[e("p",{class:"primary-text"},"点击或拖拽图片到这里上传"),e("p",{class:"secondary-text"}," 支持 JPG、PNG、WebP 格式，大图片将快速压缩 "),e("p",{class:"tertiary-text"}," ⚡ 使用高性能压缩引擎，速度提升80%+ ")],-1))]))],34),A.value?(r(),v("div",$a,[t(P,{title:A.value,type:"error",closable:!0,onClose:m[0]||(m[0]=o=>A.value=""),"show-icon":""},null,8,["title"])])):x("",!0),L.value&&i.value?(r(),v("div",ka,[e("div",Ia,[e("div",Ma,[t(C,{class:"stats-icon"},{default:n(()=>[t(y(rt))]),_:1}),m[4]||(m[4]=e("span",{class:"stats-title"},"处理完成",-1)),t(u,{type:L.value.compressionRatio>50?"success":"info",size:"small"},{default:n(()=>[D(" 优化 "+f(L.value.compressionRatio.toFixed(1))+"% ",1)]),_:1},8,["type"])]),e("div",Ca,[e("div",xa,[m[5]||(m[5]=e("span",{class:"stats-label"},"原始大小:",-1)),e("span",za,f(W(L.value.originalSize)),1)]),e("div",Da,[m[6]||(m[6]=e("span",{class:"stats-label"},"压缩后:",-1)),e("span",Ba,f(W(L.value.compressedSize)),1)]),e("div",Fa,[m[7]||(m[7]=e("span",{class:"stats-label"},"处理时间:",-1)),e("span",Va,f(L.value.processingTime)+"ms",1)]),e("div",Ea,[m[8]||(m[8]=e("span",{class:"stats-label"},"图片尺寸:",-1)),e("span",Ua,f(L.value.width)+"×"+f(L.value.height),1)])])])])):x("",!0)]),e("input",{ref_key:"fileInput",ref:k,type:"file",accept:"image/jpeg,image/jpg,image/png,image/webp",onChange:_e,style:{display:"none"}},null,544)])}}}),Ta=Oe(Sa,[["__scopeId","data-v-f6a43a15"]]),Aa={class:"batch-image-upload"},Wa={class:"upload-config"},ja={key:0,class:"upload-hint"},Ga={key:1,class:"uploading-state"},La={class:"upload-progress"},Ra={class:"upload-text"},Oa={key:2,class:"files-preview"},Na={class:"files-grid"},qa={class:"file-preview"},Ja=["src","alt"],Ha={key:1,class:"no-preview"},Ya={key:2,class:"status-overlay uploading"},Ka={key:3,class:"status-overlay success"},Xa={key:4,class:"status-overlay error"},Qa={class:"file-info"},Za={class:"file-name"},Pa={class:"file-meta"},es={class:"file-size"},ts={class:"upload-actions"},as={key:0,class:"upload-results"},ss={class:"results-summary"},ls={class:"results-detail"},os={class:"results-list"},is={class:"result-icon"},ns={class:"result-content"},rs={class:"result-filename"},us={key:0,class:"result-success"},ds={key:1,class:"result-error"},cs=Ne({__name:"BatchImageUpload",props:{productId:{},maxFiles:{default:10}},emits:["upload-complete"],setup(N,{emit:h}){const g=N,p=h,U=w(),k=w([]),i=w(!1),d=w([]),$=w(!1),M=w(0),V=w(""),A=w({image_type:"product",auto_set_primary:!1}),q=be(()=>d.value.filter(B=>B.success).length),j=be(()=>d.value.filter(B=>!B.success).length),L=l(B=>{if(B===0)return"0 B";const _=1024,W=["B","KB","MB","GB"],c=Math.floor(Math.log(B)/Math.log(_));return parseFloat((B/Math.pow(_,c)).toFixed(2))+" "+W[c]},"formatFileSize"),H=l(B=>["image/jpeg","image/jpg","image/png","image/webp"].includes(B.type)?B.size>10*1024*1024?(F.error("文件 ".concat(B.name," 过大，请选择小于10MB的图片")),!1):!0:(F.error("文件 ".concat(B.name," 格式不支持，请选择 JPG、PNG 或 WebP 格式")),!1),"validateFile"),J=l(B=>new Promise((_,W)=>{const c=new FileReader;c.onload=m=>{var C;return _((C=m.target)==null?void 0:C.result)},c.onerror=W,c.readAsDataURL(B)}),"createFilePreview"),ne=l(B=>Y(this,null,function*(){const _=[];for(const c of B)H(c)&&_.push(c);if(k.value.length+_.length>g.maxFiles){const c=g.maxFiles-k.value.length;_.splice(c),F.warning("最多只能上传 ".concat(g.maxFiles," 张图片，已自动限制为 ").concat(c," 张"))}for(const c of _){const m={file:c,name:c.name,size:c.size};try{m.preview=yield J(c)}catch(C){}k.value.push(m)}_.length>0&&F.success("添加了 ".concat(_.length," 张图片"))}),"addFiles"),re=l(B=>{k.value.splice(B,1)},"removeFile"),ue=l(()=>{k.value=[],d.value=[],M.value=0,V.value=""},"clearFiles"),ce=l(()=>{ee()},"addMoreFiles"),ee=l(()=>{var B;i.value||(B=U.value)==null||B.click()},"triggerFileInput"),Q=l(B=>Y(this,null,function*(){const _=B.target,W=Array.from(_.files||[]);W.length>0&&(yield ne(W)),_.value=""}),"handleFileSelect"),de=l(B=>{i.value||(B.preventDefault(),$.value=!0)},"handleDragOver"),_e=l(()=>{$.value=!1},"handleDragLeave"),fe=l(B=>Y(this,null,function*(){var W;if(i.value)return;B.preventDefault(),$.value=!1;const _=Array.from(((W=B.dataTransfer)==null?void 0:W.files)||[]);_.length>0&&(yield ne(_))}),"handleDrop"),S=l(()=>Y(this,null,function*(){var B,_;if(k.value.length!==0){i.value=!0,d.value=[],M.value=0,V.value="准备上传...";try{const W=new FormData;k.value.forEach(C=>{W.append("images",C.file)}),W.append("image_type",A.value.image_type),W.append("auto_set_primary",A.value.auto_set_primary.toString()),V.value="上传中...";const c=yield ie.post("/products/".concat(g.productId,"/gallery/batch-upload"),W,{onUploadProgress:l(C=>{if(C.total){const R=C.loaded/C.total*100;M.value=Math.round(R),V.value="上传中... ".concat(Math.round(R),"%")}},"onUploadProgress")});V.value="处理完成",M.value=100,d.value=c.data.results||[],k.value.forEach((C,R)=>{const Z=d.value.find(P=>P.filename===C.file.name);Z&&(C.success=Z.success,C.error=Z.error)});const m=c.data.message||"上传完成: 成功 ".concat(q.value," 个，失败 ").concat(j.value," 个");j.value===0?F.success(m):F.warning(m),p("upload-complete",d.value)}catch(W){V.value="上传失败";const c=((_=(B=W.response)==null?void 0:B.data)==null?void 0:_.error)||"批量上传失败";F.error(c),k.value.forEach(m=>{m.error=c})}finally{i.value=!1,setTimeout(()=>{i.value||(V.value="")},3e3)}}}),"startUpload");return(B,_)=>{const W=$t,c=bt,m=wt,C=Yt,R=kt,Z=Ht,P=ht,u=Je,o=nt,I=qe,T=yt,le=He,ye=Xt,Ve=Kt;return r(),v("div",Aa,[e("div",Wa,[t(P,{model:A.value,"label-width":"100px",size:"small"},{default:n(()=>[t(Z,{gutter:20},{default:n(()=>[t(C,{span:12},{default:n(()=>[t(m,{label:"图片类型"},{default:n(()=>[t(c,{modelValue:A.value.image_type,"onUpdate:modelValue":_[0]||(_[0]=O=>A.value.image_type=O),style:{width:"100%"}},{default:n(()=>[t(W,{label:"产品图",value:"product"}),t(W,{label:"细节图",value:"detail"}),t(W,{label:"使用图",value:"usage"}),t(W,{label:"对比图",value:"comparison"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),t(C,{span:12},{default:n(()=>[t(m,{label:"自动主图"},{default:n(()=>[t(R,{modelValue:A.value.auto_set_primary,"onUpdate:modelValue":_[1]||(_[1]=O=>A.value.auto_set_primary=O),"active-text":"首张设为主图","inactive-text":"不设主图"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),e("div",{class:oe(["upload-area",{"drag-over":$.value,uploading:i.value}]),onDrop:fe,onDragover:ae(de,["prevent"]),onDragleave:ae(_e,["prevent"]),onClick:ee},[!i.value&&k.value.length===0?(r(),v("div",ja,[t(u,{class:"upload-icon",size:"48"},{default:n(()=>[t(y(Fe))]),_:1}),_[2]||(_[2]=e("div",{class:"hint-text"},[e("p",{class:"primary-text"},"拖拽多张图片到这里或点击选择"),e("p",{class:"secondary-text"},"支持 JPG、PNG、WebP 格式，最多同时上传10张"),e("p",{class:"tertiary-text"},"批量上传将自动压缩优化，提升加载速度")],-1))])):i.value?(r(),v("div",Ga,[t(u,{class:"uploading-icon",size:"32"},{default:n(()=>[t(y(Le))]),_:1}),e("div",La,[t(o,{percentage:M.value,"stroke-width":8,color:"#67c23a"},null,8,["percentage"])]),e("p",Ra,f(V.value),1)])):(r(),v("div",Oa,[e("h4",null,"待上传文件 ("+f(k.value.length)+"/10)",1),e("div",Na,[(r(!0),v(Me,null,De(k.value,(O,he)=>(r(),v("div",{key:he,class:oe(["file-item",{uploading:O.uploading,success:O.success,error:O.error}])},[e("div",qa,[O.preview?(r(),v("img",{key:0,src:O.preview,alt:O.name,class:"preview-image"},null,8,Ja)):(r(),v("div",Ha,[t(u,null,{default:n(()=>[t(y(rt))]),_:1})])),O.uploading?(r(),v("div",Ya,[t(u,{class:"status-icon"},{default:n(()=>[t(y(Le))]),_:1}),_[3]||(_[3]=e("span",{class:"status-text"},"处理中...",-1))])):O.success?(r(),v("div",Ka,[t(u,{class:"status-icon"},{default:n(()=>[t(y(ft))]),_:1}),_[4]||(_[4]=e("span",{class:"status-text"},"成功",-1))])):O.error?(r(),v("div",Xa,[t(u,{class:"status-icon"},{default:n(()=>[t(y(gt))]),_:1}),_[5]||(_[5]=e("span",{class:"status-text"},"失败",-1))])):x("",!0)]),e("div",Qa,[e("div",Za,f(O.name),1),e("div",Pa,[e("span",es,f(L(O.size)),1),i.value?x("",!0):(r(),te(I,{key:0,type:"danger",size:"small",text:"",onClick:l($e=>re(he),"onClick")},{default:n(()=>_[6]||(_[6]=[D(" 移除 ",-1)])),_:2,__:[6]},1032,["onClick"]))])])],2))),128))]),e("div",ts,[t(I,{onClick:ce},{default:n(()=>[t(u,null,{default:n(()=>[t(y(Fe))]),_:1}),_[7]||(_[7]=D(" 继续添加 ",-1))]),_:1,__:[7]}),t(I,{onClick:ue},{default:n(()=>[t(u,null,{default:n(()=>[t(y(Be))]),_:1}),_[8]||(_[8]=D(" 清空全部 ",-1))]),_:1,__:[8]}),t(I,{type:"primary",loading:i.value,onClick:S,disabled:k.value.length===0},{default:n(()=>[t(u,null,{default:n(()=>[t(y(It))]),_:1}),D(" 开始上传 ("+f(k.value.length)+") ",1)]),_:1},8,["loading","disabled"])])]))],34),d.value.length>0?(r(),v("div",as,[_[11]||(_[11]=e("h4",null,"上传结果",-1)),e("div",ss,[t(T,{title:"上传完成: 成功 ".concat(q.value," 个，失败 ").concat(j.value," 个"),type:j.value===0?"success":"warning",closable:!1,"show-icon":""},null,8,["title","type"])]),e("div",ls,[t(Ve,null,{default:n(()=>[t(ye,{title:"查看详细结果",name:"details"},{default:n(()=>[e("div",os,[(r(!0),v(Me,null,De(d.value,(O,he)=>{var $e;return r(),v("div",{key:he,class:oe(["result-item",{success:O.success,error:!O.success}])},[e("div",is,[O.success?(r(),te(u,{key:0,class:"success-icon"},{default:n(()=>[t(y(ft))]),_:1})):(r(),te(u,{key:1,class:"error-icon"},{default:n(()=>[t(y(gt))]),_:1}))]),e("div",ns,[e("div",rs,f(O.filename),1),O.success?(r(),v("div",us,[_[10]||(_[10]=D(" 上传成功 ",-1)),($e=O.image)!=null&&$e.is_primary?(r(),te(le,{key:0,size:"small",type:"warning"},{default:n(()=>_[9]||(_[9]=[D("主图",-1)])),_:1,__:[9]})):x("",!0)])):(r(),v("div",ds,f(O.error),1))])],2)}),128))])]),_:1})]),_:1})])])):x("",!0),e("input",{ref_key:"fileInput",ref:U,type:"file",accept:"image/jpeg,image/jpg,image/png,image/webp",multiple:"",onChange:Q,style:{display:"none"}},null,544)])}}}),ps=Oe(cs,[["__scopeId","data-v-cc96c3cc"]]),vs={class:"gallery-manager"},ms={class:"toolbar"},_s={class:"toolbar-left"},fs={class:"toolbar-right"},gs={key:0,class:"stats-bar"},ys={class:"stats-content"},hs={class:"stat-item"},ws={class:"stat-value"},bs={class:"stat-item"},$s={class:"stat-value"},ks={class:"stat-item"},Is={class:"images-grid"},Ms={class:"selection-checkbox"},Cs={key:0,class:"primary-badge"},xs=["onClick"],zs=["src","alt"],Ds={class:"image-overlay"},Bs={class:"image-info"},Fs={class:"image-title"},Vs={class:"image-meta"},Es={class:"file-size"},Us={class:"image-actions"},Ss={class:"drag-handle"},Ts={key:0,class:"empty-state"},As={class:"dialog-footer"},Ws={key:0,class:"preview-content"},js=["src","alt"],Gs={class:"preview-info"},Ls={key:0},Rs={class:"preview-meta"},Os={class:"meta-item"},Ns={class:"meta-item"},qs={class:"meta-item"},Js={class:"meta-item"},Hs=Ne({__name:"ProductGalleryManager",props:mt({productId:{},images:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:mt(["refresh","update:visible"],["update:visible"]),setup(N,{emit:h}){const g=N,p=h,U=Ot(N,"visible"),k=w(!1),i=w([]),d=w([]),$=w(null),M=w(""),V=w(!1),A=w(!1),q=w(!1),j=w(!1),L=w(null),H=w({title:"",description:"",alt_text:"",image_type:"product",is_primary:!1}),J=w(null),ne=be(()=>M.value?i.value.filter(u=>u.image_type===M.value):i.value),re=l(u=>u?u.startsWith("data:")||u.startsWith("http://")||u.startsWith("https://")?u:u.startsWith("/api/v1")?"http://localhost:5173".concat(u):"http://localhost:5173/api/v1/products/uploads/".concat(u):"/images/default-product.svg","getImageUrl"),ue=l(u=>({product:"产品图",detail:"细节图",usage:"使用图",comparison:"对比图"})[u]||"产品图","getImageTypeLabel"),ce=l(u=>({product:"primary",detail:"success",usage:"warning",comparison:"info"})[u]||"primary","getImageTypeTagType"),ee=l(u=>{if(u===0)return"0 B";const o=1024,I=["B","KB","MB","GB"],T=Math.floor(Math.log(u)/Math.log(o));return parseFloat((u/Math.pow(o,T)).toFixed(2))+" "+I[T]},"formatFileSize"),Q=l(()=>Y(this,null,function*(){var u,o;if(g.productId){k.value=!0;try{const[I,T]=yield Promise.all([ie.get("/products/".concat(g.productId,"/gallery")),ie.get("/products/".concat(g.productId,"/gallery/stats"))]);i.value=I.images||[],$.value=T,d.value=[]}catch(I){F.error(((o=(u=I.response)==null?void 0:u.data)==null?void 0:o.error)||"加载图片失败")}finally{k.value=!1}}}),"loadImages"),de=l(u=>{const o=d.value.indexOf(u);o>-1?d.value.splice(o,1):d.value.push(u)},"toggleImageSelection"),_e=l(u=>Y(this,null,function*(){var o,I;try{yield ie.post("/products/".concat(g.productId,"/gallery/").concat(u,"/set-primary")),F.success("主图设置成功"),yield Q(),p("refresh")}catch(T){F.error(((I=(o=T.response)==null?void 0:o.data)==null?void 0:I.error)||"设置主图失败")}}),"setPrimaryImage"),fe=l(u=>{L.value=u,H.value={title:u.title||"",description:u.description||"",alt_text:u.alt_text||"",image_type:u.image_type,is_primary:u.is_primary},q.value=!0},"editImage"),S=l(()=>Y(this,null,function*(){var u,o;if(L.value)try{yield ie.put("/products/".concat(g.productId,"/gallery/").concat(L.value.id),H.value),F.success("图片信息已更新"),q.value=!1,yield Q(),p("refresh")}catch(I){F.error(((o=(u=I.response)==null?void 0:u.data)==null?void 0:o.error)||"更新失败")}}),"saveImageEdit"),B=l(u=>Y(this,null,function*(){var o,I;try{yield Re.confirm("确定要删除这张图片吗？删除后无法恢复。","确认删除",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning",confirmButtonClass:"el-button--danger"}),yield ie.delete("/products/".concat(g.productId,"/gallery/").concat(u)),F.success("图片删除成功"),yield Q(),p("refresh")}catch(T){T!=="cancel"&&F.error(((I=(o=T.response)==null?void 0:o.data)==null?void 0:I.error)||"删除失败")}}),"deleteImage"),_=l(()=>Y(this,null,function*(){var u,o;if(d.value.length!==0)try{yield Re.confirm("确定要删除选中的 ".concat(d.value.length," 张图片吗？删除后无法恢复。"),"批量删除确认",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning",confirmButtonClass:"el-button--danger"});const I=d.value.map(T=>ie.delete("/products/".concat(g.productId,"/gallery/").concat(T)));yield Promise.all(I),F.success("成功删除 ".concat(d.value.length," 张图片")),d.value=[],yield Q(),p("refresh")}catch(I){I!=="cancel"&&F.error(((o=(u=I.response)==null?void 0:u.data)==null?void 0:o.error)||"批量删除失败")}}),"deleteSelectedImages"),W=l(u=>{J.value=u,j.value=!0},"previewImage"),c=l((u,o)=>{F.success("图片上传成功"),V.value=!1,Q(),p("refresh")},"handleUploadSuccess"),m=l(u=>{F.error("上传失败: ".concat(u))},"handleUploadError"),C=l(u=>{const o=u.filter(I=>I.success).length;F.success("批量上传完成，成功上传 ".concat(o," 张图片")),A.value=!1,Q(),p("refresh")},"handleBatchUploadComplete"),R=l(u=>{const o=u.target;o.src="/images/default-product.svg"},"onImageError"),Z=l(()=>{U.value=!1},"handleClose"),P=l(()=>{},"initDragSort");return it(U,u=>{u&&(Q(),setTimeout(P,100))}),st(()=>{g.images&&(i.value=g.images)}),(u,o)=>{const I=qe,T=$t,le=bt,ye=Zt,Ve=ea,O=Je,he=Ct,$e=He,Ae=ta,ke=Mt,Ee=aa,Ce=wt,pe=kt,Ye=ht,Ke=Pt;return r(),te(ke,{modelValue:U.value,"onUpdate:modelValue":o[13]||(o[13]=xe=>U.value=xe),title:"图片管理",width:"80%",class:"gallery-manager-dialog","before-close":Z},{default:n(()=>{var xe;return[e("div",vs,[e("div",ms,[e("div",_s,[t(I,{type:"primary",icon:y(Fe),onClick:o[0]||(o[0]=b=>V.value=!0)},{default:n(()=>o[14]||(o[14]=[D(" 添加图片 ",-1)])),_:1,__:[14]},8,["icon"]),t(I,{icon:y(It),onClick:o[1]||(o[1]=b=>A.value=!0)},{default:n(()=>o[15]||(o[15]=[D(" 批量上传 ",-1)])),_:1,__:[15]},8,["icon"]),d.value.length>0?(r(),te(I,{key:0,type:"danger",icon:y(Be),onClick:_},{default:n(()=>[D(" 删除选中 ("+f(d.value.length)+") ",1)]),_:1},8,["icon"])):x("",!0)]),e("div",fs,[t(le,{modelValue:M.value,"onUpdate:modelValue":o[2]||(o[2]=b=>M.value=b),placeholder:"筛选图片类型",clearable:"",style:{width:"140px"}},{default:n(()=>[t(T,{label:"产品图",value:"product"}),t(T,{label:"细节图",value:"detail"}),t(T,{label:"使用图",value:"usage"}),t(T,{label:"对比图",value:"comparison"})]),_:1},8,["modelValue"]),t(I,{icon:y(Qt),onClick:Q,loading:k.value},{default:n(()=>o[16]||(o[16]=[D(" 刷新 ",-1)])),_:1,__:[16]},8,["icon","loading"])])]),$.value?(r(),v("div",gs,[t(ye,{class:"stats-card",shadow:"never"},{default:n(()=>[e("div",ys,[e("div",hs,[o[17]||(o[17]=e("span",{class:"stat-label"},"总图片:",-1)),e("span",ws,f($.value.total_images),1)]),e("div",bs,[o[18]||(o[18]=e("span",{class:"stat-label"},"总大小:",-1)),e("span",$s,f(ee($.value.total_size)),1)]),e("div",ks,[o[19]||(o[19]=e("span",{class:"stat-label"},"主图:",-1)),e("span",{class:oe(["stat-value",{"text-success":$.value.has_primary,"text-warning":!$.value.has_primary}])},f($.value.has_primary?"已设置":"未设置"),3)])])]),_:1})])):x("",!0),Nt((r(),v("div",Is,[(r(!0),v(Me,null,De(ne.value,b=>(r(),v("div",{key:b.id,class:oe(["image-card",{selected:d.value.includes(b.id),primary:b.is_primary}])},[e("div",Ms,[t(Ve,{"model-value":d.value.includes(b.id),onChange:l(we=>de(b.id),"onChange")},null,8,["model-value","onChange"])]),b.is_primary?(r(),v("div",Cs,[t(O,null,{default:n(()=>[t(y(Se))]),_:1}),o[20]||(o[20]=D(" 主图 ",-1))])):x("",!0),e("div",{class:"image-preview",onClick:l(we=>W(b),"onClick")},[e("img",{src:re(b.thumbnail_url||b.image_url),alt:b.title,class:"preview-img",onError:R},null,40,zs),e("div",Ds,[t(he,null,{default:n(()=>[t(I,{size:"small",icon:y(lt)},{default:n(()=>o[21]||(o[21]=[D("预览",-1)])),_:1,__:[21]},8,["icon"]),t(I,{size:"small",icon:y(Te),onClick:ae(we=>fe(b),["stop"])},{default:n(()=>o[22]||(o[22]=[D("编辑",-1)])),_:2,__:[22]},1032,["icon","onClick"])]),_:2},1024)])],8,xs),e("div",Bs,[e("div",Fs,f(b.title||b.filename),1),e("div",Vs,[t($e,{size:"small",type:ce(b.image_type)},{default:n(()=>[D(f(ue(b.image_type)),1)]),_:2},1032,["type"]),e("span",Es,f(ee(b.file_size||0)),1)])]),e("div",Us,[t(he,null,{default:n(()=>[b.is_primary?x("",!0):(r(),te(I,{key:0,size:"small",type:"warning",onClick:l(we=>_e(b.id),"onClick")},{default:n(()=>o[23]||(o[23]=[D(" 设为主图 ",-1)])),_:2,__:[23]},1032,["onClick"])),t(I,{size:"small",icon:y(Te),onClick:l(we=>fe(b),"onClick")},{default:n(()=>o[24]||(o[24]=[D(" 编辑 ",-1)])),_:2,__:[24]},1032,["icon","onClick"]),t(I,{size:"small",type:"danger",icon:y(Be),onClick:l(we=>B(b.id),"onClick")},{default:n(()=>o[25]||(o[25]=[D(" 删除 ",-1)])),_:2,__:[25]},1032,["icon","onClick"])]),_:2},1024)]),e("div",Ss,[t(O,null,{default:n(()=>[t(y(xt))]),_:1})])],2))),128)),!k.value&&ne.value.length===0?(r(),v("div",Ts,[t(Ae,{description:"暂无图片"})])):x("",!0)])),[[Ke,k.value]])]),t(ke,{modelValue:V.value,"onUpdate:modelValue":o[3]||(o[3]=b=>V.value=b),title:"上传图片",width:"600px","before-close":l(()=>V.value=!1,"before-close")},{default:n(()=>[t(Ta,{"product-id":u.productId,onUploadSuccess:c,onUploadError:m},null,8,["product-id"])]),_:1},8,["modelValue","before-close"]),t(ke,{modelValue:A.value,"onUpdate:modelValue":o[4]||(o[4]=b=>A.value=b),title:"批量上传图片",width:"700px","before-close":l(()=>A.value=!1,"before-close")},{default:n(()=>[t(ps,{"product-id":u.productId,onUploadComplete:C},null,8,["product-id"])]),_:1},8,["modelValue","before-close"]),t(ke,{modelValue:q.value,"onUpdate:modelValue":o[11]||(o[11]=b=>q.value=b),title:"编辑图片信息",width:"500px","before-close":l(()=>q.value=!1,"before-close")},{default:n(()=>[L.value?(r(),te(Ye,{key:0,model:H.value,"label-width":"80px",onSubmit:ae(S,["prevent"])},{default:n(()=>[t(Ce,{label:"标题"},{default:n(()=>[t(Ee,{modelValue:H.value.title,"onUpdate:modelValue":o[5]||(o[5]=b=>H.value.title=b),placeholder:"图片标题"},null,8,["modelValue"])]),_:1}),t(Ce,{label:"描述"},{default:n(()=>[t(Ee,{modelValue:H.value.description,"onUpdate:modelValue":o[6]||(o[6]=b=>H.value.description=b),type:"textarea",rows:3,placeholder:"图片描述"},null,8,["modelValue"])]),_:1}),t(Ce,{label:"替代文本"},{default:n(()=>[t(Ee,{modelValue:H.value.alt_text,"onUpdate:modelValue":o[7]||(o[7]=b=>H.value.alt_text=b),placeholder:"用于屏幕阅读器"},null,8,["modelValue"])]),_:1}),t(Ce,{label:"图片类型"},{default:n(()=>[t(le,{modelValue:H.value.image_type,"onUpdate:modelValue":o[8]||(o[8]=b=>H.value.image_type=b),style:{width:"100%"}},{default:n(()=>[t(T,{label:"产品图",value:"product"}),t(T,{label:"细节图",value:"detail"}),t(T,{label:"使用图",value:"usage"}),t(T,{label:"对比图",value:"comparison"})]),_:1},8,["modelValue"])]),_:1}),t(Ce,{label:"设为主图"},{default:n(()=>[t(pe,{modelValue:H.value.is_primary,"onUpdate:modelValue":o[9]||(o[9]=b=>H.value.is_primary=b)},null,8,["modelValue"])]),_:1}),e("div",As,[t(I,{onClick:o[10]||(o[10]=b=>q.value=!1)},{default:n(()=>o[26]||(o[26]=[D("取消",-1)])),_:1,__:[26]}),t(I,{type:"primary",onClick:S},{default:n(()=>o[27]||(o[27]=[D("保存",-1)])),_:1,__:[27]})])]),_:1},8,["model"])):x("",!0)]),_:1},8,["modelValue","before-close"]),t(ke,{modelValue:j.value,"onUpdate:modelValue":o[12]||(o[12]=b=>j.value=b),title:((xe=J.value)==null?void 0:xe.title)||"图片预览",width:"80%",class:"preview-dialog","before-close":l(()=>j.value=!1,"before-close")},{default:n(()=>{var b;return[J.value?(r(),v("div",Ws,[e("img",{src:re(J.value.image_url),alt:J.value.title,class:"preview-image"},null,8,js),e("div",Gs,[e("h4",null,f(J.value.title||J.value.filename),1),J.value.description?(r(),v("p",Ls,f(J.value.description),1)):x("",!0),e("div",Rs,[e("div",Os,[o[28]||(o[28]=e("span",{class:"meta-label"},"类型:",-1)),t($e,{type:ce(J.value.image_type)},{default:n(()=>[D(f(ue(J.value.image_type)),1)]),_:1},8,["type"])]),e("div",Ns,[o[29]||(o[29]=e("span",{class:"meta-label"},"尺寸:",-1)),e("span",null,f(J.value.width)+"×"+f(J.value.height),1)]),e("div",qs,[o[30]||(o[30]=e("span",{class:"meta-label"},"大小:",-1)),e("span",null,f(ee(J.value.file_size||0)),1)]),e("div",Js,[o[31]||(o[31]=e("span",{class:"meta-label"},"格式:",-1)),e("span",null,f((b=J.value.format)==null?void 0:b.toUpperCase()),1)])])])])):x("",!0)]}),_:1},8,["modelValue","title","before-close"])]}),_:1},8,["modelValue"])}}}),Ys=Oe(Hs,[["__scopeId","data-v-092c6b41"]]),Ks={class:"main-display"},Xs={key:0,class:"image-loading"},Qs={key:1,class:"main-image-wrapper"},Zs=["src","alt"],Ps={key:0,class:"edit-overlay"},el={class:"edit-actions"},tl={key:1,class:"image-overlay"},al={class:"image-info"},sl={key:0},ll={key:1},ol={class:"image-meta"},il={class:"image-type"},nl={key:0,class:"primary-badge"},rl={key:2,class:"navigation-arrows"},ul=["disabled"],dl=["disabled"],cl={key:3,class:"image-counter"},pl={key:0,class:"uploading-state"},vl={class:"upload-progress"},ml={class:"upload-text"},_l={key:0,class:"processing-info"},fl={class:"processing-text"},gl={key:1},yl={class:"empty-hint"},hl={class:"empty-text"},wl={key:0,class:"upload-hint"},bl={class:"main-actions"},$l={key:0,class:"thumbnails-section"},kl={key:0,class:"edit-mode-hint"},Il=["onClick","draggable","onDragstart","onDrop"],Ml={class:"thumbnail-wrapper"},Cl={key:0,class:"sort-handle"},xl=["src","alt"],zl={key:1,class:"thumbnail-controls"},Dl={key:2,class:"primary-indicator"},Bl={class:"type-indicator"},Fl={class:"thumbnail-info"},Vl={class:"thumbnail-title"},El={key:0,class:"thumbnail-meta"},Ul={class:"file-size"},Sl=["onClick"],Tl={class:"thumbnail-wrapper"},Al=["src","alt"],Wl={key:0,class:"primary-indicator"},jl={class:"type-indicator"},Gl={class:"thumbnail-info"},Ll={class:"thumbnail-title"},Rl={class:"preview-content"},Ol={class:"preview-image-container"},Nl=["src","alt"],ql={class:"preview-controls"},Jl={class:"zoom-info"},Hl={key:0,class:"preview-navigation"},Yl={class:"preview-counter"},Kl={key:0,class:"stats-content"},Xl={class:"stats-item"},Ql={class:"stats-value"},Zl={class:"stats-item"},Pl={class:"stats-value"},eo={class:"stats-item"},to={class:"stats-value"},ao={class:"stats-item"},so={class:"type-breakdown"},lo=Ne({__name:"ProductGallery",props:{productId:{},editMode:{type:Boolean,default:!1},autoLoad:{type:Boolean,default:!0},showControls:{type:Boolean,default:!0},canEdit:{type:Boolean,default:!1},height:{default:"400px"}},emits:["refresh","imageChange","imagesUpdate"],setup(N,{expose:h,emit:g}){Jt(s=>({"004327c8":typeof s.height=="number"?s.height+"px":s.height}));const p=N,U=g,k=w(!1),i=w([]),d=w(0),$=w(null),M=w(!1),V=w(!1),A=w(!1),q=w(!1),j=w(!1),L=w(!1),H=w(!1),J=w(0),ne=w(!1),re=w(""),ue=w(""),ce=w(),ee=w(1),Q=w({x:0,y:0}),de=w(!1),_e=w({x:0,y:0}),fe=w(!1),S=be(()=>{if(!Array.isArray(i.value)||i.value.length===0)return null;const s=d.value;return s<0||s>=i.value.length?null:i.value[s]||null}),B=be(()=>({transform:"scale(".concat(ee.value,") translate(").concat(Q.value.x,"px, ").concat(Q.value.y,"px)"),cursor:de.value?"grabbing":"grab"})),_=l(s=>s?s.startsWith("data:")||s.startsWith("http://")||s.startsWith("https://")||s.startsWith("/api/v1")||s.startsWith("/")?s:"/api/v1/products/uploads/".concat(s):"/images/default-product.svg","getImageUrl"),W=l(s=>({product:"产品图",detail:"细节图",usage:"使用图",comparison:"对比图"})[s]||"产品图","getImageTypeLabel"),c=l(s=>{if(s===0)return"0 B";const a=1024,G=["B","KB","MB","GB"],K=Math.floor(Math.log(s)/Math.log(a));return parseFloat((s/Math.pow(a,K)).toFixed(2))+" "+G[K]},"formatFileSize"),m=l(()=>Y(this,null,function*(){var s,a,G;if(p.productId){k.value=!0;try{const E=yield ie.get("/products/".concat(p.productId,"/gallery")),X=E==null?void 0:E.images;if(i.value=Array.isArray(X)?X:[],E!=null&&E.primary_image&&i.value.length>0){const ve=i.value.findIndex(ge=>ge&&ge.is_primary);ve>=0&&(d.value=ve)}try{const ve=yield ie.get("/products/".concat(p.productId,"/gallery/stats"));$.value=ve||null}catch(ve){$.value=null}U("imagesUpdate",i.value),yield _t()}catch(K){i.value=[],U("imagesUpdate",[]),((s=K.response)==null?void 0:s.status)!==404&&F.error(((G=(a=K.response)==null?void 0:a.data)==null?void 0:G.error)||"加载图片集失败")}finally{k.value=!1}}}),"loadGallery"),C=l(s=>{if(!Array.isArray(i.value)||s<0||s>=i.value.length)return;d.value=s;const a=i.value[s];a&&a.image_url&&U("imageChange",a.image_url)},"selectImage"),R=l(()=>{!Array.isArray(i.value)||i.value.length===0||d.value>0&&d.value--},"prevImage"),Z=l(()=>{!Array.isArray(i.value)||i.value.length===0||d.value<i.value.length-1&&d.value++},"nextImage"),P=l(()=>{S.value&&(V.value=!0,We())},"openPreview"),u=l(()=>{V.value=!1,We()},"closePreview"),o=l(()=>{M.value=!M.value},"toggleImageInfo"),I=l(()=>{A.value=!0},"openManageDialog"),T=l(s=>["image/jpeg","image/jpg","image/png","image/webp"].includes(s.type)?s.size>10*1024*1024?(F.error("文件太大，请选择小于10MB的图片"),!1):!0:(F.error("不支持的文件格式。请使用 JPG、PNG 或 WebP 格式"),!1),"validateFile"),le=l(s=>Y(this,null,function*(){var G,K;const a=Array.from(s).filter(T);if(a.length===0){F.warning("请选择有效的图片文件");return}L.value=!0,J.value=0,ue.value="",re.value="开始处理图片...";try{const E=a.map((ve,ge)=>Y(this,null,function*(){re.value="正在处理图片 ".concat(ge+1,"/").concat(a.length,"...");const je=yield zt(ve,Dt.standard,(z,se)=>{const me=ge/a.length*100,Wt=z/a.length*60;J.value=me+Wt,ue.value=se}),ze=new FormData;return ze.append("image",je.file),ze.append("image_type","product"),(yield ie.post("/products/".concat(p.productId,"/gallery/upload"),ze)).data})),X=yield Promise.all(E);J.value=100,re.value="上传完成！",F.success("成功上传 ".concat(a.length," 张图片")),yield m(),U("refresh")}catch(E){const X=((K=(G=E.response)==null?void 0:G.data)==null?void 0:K.error)||E.message||"图片上传失败";F.error(X)}finally{L.value=!1,J.value=0,re.value="",ue.value=""}}),"uploadFiles"),ye=l(()=>{p.editMode&&(L.value||ce.value&&ce.value.click())},"triggerFileInput"),Ve=l(s=>{const a=s.target,G=a.files;G&&G.length>0&&le(G),a.value=""},"handleFileSelect"),O=l(s=>{p.editMode&&(L.value||(s.preventDefault(),ne.value=!0))},"handleDragOver"),he=l(()=>{ne.value=!1},"handleDragLeave"),$e=l(s=>{var G;if(!p.editMode||L.value)return;s.preventDefault(),ne.value=!1;const a=(G=s.dataTransfer)==null?void 0:G.files;a&&a.length>0&&le(a)},"handleDrop"),Ae=l(s=>Y(this,null,function*(){var a,G;try{yield ie.put("/products/".concat(p.productId,"/gallery/").concat(s,"/primary")),F.success("主图设置成功"),yield m(),U("refresh")}catch(K){F.error(((G=(a=K.response)==null?void 0:a.data)==null?void 0:G.error)||"设置主图失败")}}),"setAsPrimary"),ke=l(s=>Y(this,null,function*(){var a,G;try{yield Re.confirm("确定要删除这张图片吗？删除后无法恢复。","确认删除",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning",confirmButtonClass:"el-button--danger"}),H.value=!0,yield ie.delete("/products/".concat(p.productId,"/gallery/").concat(s)),F.success("图片删除成功"),yield m(),U("refresh")}catch(K){K!=="cancel"&&F.error(((G=(a=K.response)==null?void 0:a.data)==null?void 0:G.error)||"图片删除失败")}finally{H.value=!1}}),"deleteImage"),Ee=l(()=>{ye()},"replaceMainImage"),Ce=l(()=>{j.value=!j.value,j.value&&F.info("拖拽图片进行排序，完成后点击“完成排序”")},"toggleSortMode");let pe=-1;const Ye=l((s,a)=>{j.value&&(pe=s,a.dataTransfer&&(a.dataTransfer.effectAllowed="move",a.dataTransfer.setData("text/html","")))},"onDragStart"),Ke=l(s=>{j.value&&(s.preventDefault(),s.dataTransfer&&(s.dataTransfer.dropEffect="move"))},"onDragOver"),xe=l((s,a)=>Y(this,null,function*(){var G,K;if(!(!j.value||pe===-1||pe===s)&&!(!Array.isArray(i.value)||i.value.length===0)){a.preventDefault();try{const E=[...i.value],[X]=E.splice(pe,1);E.splice(s,0,X),i.value=E,pe===d.value?d.value=s:pe<d.value&&s>=d.value?d.value--:pe>d.value&&s<=d.value&&d.value++;const ve=E.map(ge=>ge.id);yield ie.put("/products/".concat(p.productId,"/gallery/sort"),{image_ids:ve}),F.success("图片顺序更新成功")}catch(E){F.error(((K=(G=E.response)==null?void 0:G.data)==null?void 0:K.error)||"排序更新失败"),yield m()}pe=-1}}),"onDrop"),b=l(()=>{pe=-1},"onDragEnd"),we=l(()=>{ee.value=Math.min(ee.value*1.2,5)},"zoomIn"),Xe=l(()=>{ee.value=Math.max(ee.value/1.2,.1)},"zoomOut"),We=l(()=>{ee.value=1,Q.value={x:0,y:0}},"resetZoom"),Bt=l(s=>{s.preventDefault(),s.deltaY<0?we():Xe()},"onPreviewWheel"),Ft=l(s=>{ee.value<=1||(de.value=!0,_e.value={x:s.clientX,y:s.clientY})},"startDrag"),Vt=l(s=>{if(!de.value||ee.value<=1)return;const a=s.clientX-_e.value.x,G=s.clientY-_e.value.y;Q.value.x+=a,Q.value.y+=G,_e.value={x:s.clientX,y:s.clientY}},"onDrag"),ut=l(()=>{de.value=!1},"endDrag"),Et=l(()=>{if(!S.value)return;const s=document.createElement("a");s.href=_(S.value.image_url),s.download=S.value.original_filename||S.value.filename,s.target="_blank",s.click()},"downloadImage"),dt=l(s=>{const a=document.querySelector(".thumbnails-scroll");if(!a)return;const G=200,K=s==="left"?a.scrollLeft-G:a.scrollLeft+G;a.scrollTo({left:K,behavior:"smooth"})},"scrollThumbnails"),Ut=l(()=>{},"onImageLoad"),St=l(s=>{const a=s.target;a.src,a.src.includes("default-product.svg")||(a.src="/images/default-product.svg",F.warning("图片加载失败，已显示默认图片"))},"onImageError"),ct=l(s=>{const a=s.target;a.src,a.src.includes("default-product.svg")||(a.src="/images/default-product.svg")},"onThumbnailError"),Tt=l(()=>Y(this,null,function*(){yield m()}),"refreshGallery");st(()=>Y(this,null,function*(){p.autoLoad&&(yield m()),yield _t();const s=document.querySelector(".thumbnails-scroll"),a=document.querySelector(".thumbnails-container");s&&a&&(fe.value=s.scrollWidth>a.clientWidth)}));const At=l(s=>{if(V.value)switch(s.key){case"ArrowLeft":R();break;case"ArrowRight":Z();break;case"Escape":u();break;case"+":case"=":we();break;case"-":Xe();break;case"0":We();break}},"handleKeydown");return h({loadGallery:m,selectImage:C,openPreview:P,currentImage:S,images:i}),it(()=>p.productId,(s,a)=>{s&&s!==a&&p.autoLoad&&m()},{immediate:!1}),st(()=>{document.addEventListener("keydown",At)}),(s,a)=>{var Qe;const G=la,K=sa,E=qe,X=Je,ve=nt,ge=Ct,je=He,ze=Mt;return r(),v("div",{class:oe(["product-gallery",{"edit-mode":s.editMode}])},[e("div",Ks,[e("div",{class:oe(["main-image-container",{"edit-mode":s.editMode}])},[k.value?(r(),v("div",Xs,[t(K,{animated:""},{template:n(()=>[t(G,{variant:"image",style:{width:"100%",height:"400px"}})]),_:1})])):S.value?(r(),v("div",Qs,[e("img",{src:_(S.value.image_url),alt:S.value.alt_text||S.value.title||"产品图片",class:oe(["main-image",{"edit-mode":s.editMode}]),onLoad:Ut,onError:St,onClick:a[0]||(a[0]=z=>!s.editMode&&P())},null,42,Zs),s.editMode&&S.value?(r(),v("div",Ps,[e("div",el,[t(E,{type:"primary",size:"small",icon:y(Te),onClick:ae(Ee,["stop"])},{default:n(()=>a[14]||(a[14]=[D(" 更换主图 ",-1)])),_:1,__:[14]},8,["icon"]),S.value.is_primary?x("",!0):(r(),te(E,{key:0,type:"warning",size:"small",icon:y(Se),onClick:a[1]||(a[1]=ae(z=>Ae(S.value.id),["stop"]))},{default:n(()=>a[15]||(a[15]=[D(" 设为主图 ",-1)])),_:1,__:[15]},8,["icon"])),t(E,{type:"danger",size:"small",icon:y(Be),onClick:a[2]||(a[2]=ae(z=>ke(S.value.id),["stop"])),disabled:H.value},{default:n(()=>a[16]||(a[16]=[D(" 删除 ",-1)])),_:1,__:[16]},8,["icon","disabled"])])])):!s.editMode&&M.value&&S.value?(r(),v("div",tl,[e("div",al,[S.value.title?(r(),v("h4",sl,f(S.value.title),1)):x("",!0),S.value.description?(r(),v("p",ll,f(S.value.description),1)):x("",!0),e("div",ol,[e("span",il,f(W(S.value.image_type)),1),S.value.is_primary?(r(),v("span",nl,"主图")):x("",!0)])])])):x("",!0),!s.editMode&&Array.isArray(i.value)&&i.value.length>1?(r(),v("div",rl,[e("button",{class:"nav-arrow prev",disabled:d.value===0,onClick:R},[t(X,null,{default:n(()=>[t(y(et))]),_:1})],8,ul),e("button",{class:"nav-arrow next",disabled:d.value===i.value.length-1,onClick:Z},[t(X,null,{default:n(()=>[t(y(tt))]),_:1})],8,dl)])):x("",!0),Array.isArray(i.value)&&i.value.length>1?(r(),v("div",cl,f(d.value+1)+" / "+f(i.value.length),1)):x("",!0)])):(r(),v("div",{key:2,class:oe(["empty-state",{"edit-mode":s.editMode,"drag-over":ne.value,uploading:L.value}]),onDragover:a[3]||(a[3]=ae(z=>s.editMode&&O,["prevent"])),onDragleave:a[4]||(a[4]=ae(z=>s.editMode&&he,["prevent"])),onDrop:a[5]||(a[5]=ae(z=>s.editMode&&$e,["prevent"])),onClick:a[6]||(a[6]=z=>s.editMode&&ye)},[L.value?(r(),v("div",pl,[t(X,{class:"uploading-icon"},{default:n(()=>[t(y(Le))]),_:1}),e("div",vl,[t(ve,{percentage:J.value,"stroke-width":8,color:"#2563eb"},null,8,["percentage"])]),e("p",ml,f(re.value),1),ue.value?(r(),v("div",_l,[e("p",fl,f(ue.value),1)])):x("",!0)])):(r(),v("div",gl,[t(X,{class:"empty-icon",size:"48"},{default:n(()=>[s.editMode?(r(),te(y(Fe),{key:1})):(r(),te(y(rt),{key:0}))]),_:1}),e("div",yl,[e("p",hl,f(s.editMode?"点击或拖拽图片到这里上传":"暂无产品图片"),1),s.editMode?(r(),v("p",wl," 支持 JPG、PNG、WebP 格式，大图片将快速压缩 ")):x("",!0)])]))],34))],2),e("div",bl,[t(ge,null,{default:n(()=>[s.editMode?(r(),v(Me,{key:1},[t(E,{icon:y(Fe),onClick:ye},{default:n(()=>a[19]||(a[19]=[D(" 添加图片 ",-1)])),_:1,__:[19]},8,["icon"]),Array.isArray(i.value)&&i.value.length>0?(r(),te(E,{key:0,icon:y(oa),onClick:Ce},{default:n(()=>[D(f(j.value?"完成排序":"排序图片"),1)]),_:1},8,["icon"])):x("",!0),$.value?(r(),te(E,{key:1,icon:y(at),onClick:a[7]||(a[7]=z=>q.value=!0)},{default:n(()=>a[20]||(a[20]=[D(" 统计信息 ",-1)])),_:1,__:[20]},8,["icon"])):x("",!0)],64)):(r(),v(Me,{key:0},[S.value?(r(),te(E,{key:0,icon:y(lt),onClick:P},{default:n(()=>a[17]||(a[17]=[D(" 放大查看 ",-1)])),_:1,__:[17]},8,["icon"])):x("",!0),t(E,{icon:y(at),onClick:o},{default:n(()=>[D(f(M.value?"隐藏信息":"显示信息"),1)]),_:1},8,["icon"]),s.canEdit?(r(),te(E,{key:1,icon:y(Te),onClick:I},{default:n(()=>a[18]||(a[18]=[D(" 管理图片 ",-1)])),_:1,__:[18]},8,["icon"])):x("",!0)],64))]),_:1})])]),Array.isArray(i.value)&&i.value.length>0?(r(),v("div",$l,[e("h4",{class:oe(["thumbnails-title",{"edit-mode":s.editMode}])},[D(f(s.editMode?"管理图片":"所有图片")+" ("+f(Array.isArray(i.value)?i.value.length:0)+") ",1),$.value?(r(),te(je,{key:0,size:"small",type:"info"},{default:n(()=>[D(f(c($.value.total_size)),1)]),_:1})):x("",!0)],2),e("div",{class:oe(["thumbnails-container",{"sort-mode":j.value,"edit-mode":s.editMode}])},[s.editMode&&!L.value&&Array.isArray(i.value)&&i.value.length>0?(r(),v("div",kl,[t(X,null,{default:n(()=>[t(y(at))]),_:1}),e("span",null,f(j.value?"拖拽图片进行排序，完成后点击“完成排序”":"点击图片上的按钮进行编辑操作"),1)])):x("",!0),e("div",{class:oe(["thumbnails-scroll",{"edit-mode":s.editMode}])},[s.editMode?(r(!0),v(Me,{key:0},De(i.value,(z,se)=>(r(),v("div",{key:z.id,class:oe(["thumbnail-item",{active:se===d.value,primary:z.is_primary,"edit-mode":!0,"sort-mode":j.value}]),onClick:l(me=>!j.value&&C(se),"onClick"),draggable:j.value,onDragstart:l(me=>Ye(se,me),"onDragstart"),onDragover:a[8]||(a[8]=me=>Ke(me)),onDrop:l(me=>xe(se,me),"onDrop"),onDragend:b},[e("div",Ml,[j.value?(r(),v("div",Cl,[t(X,null,{default:n(()=>[t(y(xt))]),_:1})])):x("",!0),e("img",{src:_(z.thumbnail_url||z.image_url),alt:z.title||"图片 ".concat(se+1),class:"thumbnail-image",onError:ct},null,40,xl),s.editMode&&!j.value?(r(),v("div",zl,[z.is_primary?x("",!0):(r(),te(E,{key:0,size:"small",type:"primary",icon:y(Se),onClick:ae(me=>Ae(z.id),["stop"]),title:"设为主图",class:"control-btn"},null,8,["icon","onClick"])),t(E,{size:"small",type:"danger",icon:y(Be),onClick:ae(me=>ke(z.id),["stop"]),disabled:H.value,title:"删除图片",class:"control-btn"},null,8,["icon","onClick","disabled"])])):x("",!0),z.is_primary?(r(),v("div",Dl,[t(X,null,{default:n(()=>[t(y(Se))]),_:1})])):x("",!0),e("div",Bl,f(W(z.image_type)),1)]),e("div",Fl,[e("span",Vl,f(z.title||"图片 ".concat(se+1)),1),s.editMode?(r(),v("div",El,[e("span",Ul,f(c(z.file_size||0)),1)])):x("",!0)])],42,Il))),128)):(r(!0),v(Me,{key:1},De(i.value,(z,se)=>(r(),v("div",{key:z.id,class:oe(["thumbnail-item",{active:se===d.value,primary:z.is_primary}]),onClick:l(me=>C(se),"onClick")},[e("div",Tl,[e("img",{src:_(z.thumbnail_url||z.image_url),alt:z.title||"图片 ".concat(se+1),class:"thumbnail-image",onError:ct},null,40,Al),z.is_primary?(r(),v("div",Wl,[t(X,null,{default:n(()=>[t(y(Se))]),_:1})])):x("",!0),e("div",jl,f(W(z.image_type)),1)]),e("div",Gl,[e("span",Ll,f(z.title||"图片 ".concat(se+1)),1)])],10,Sl))),128))],2),fe.value?(r(),v("button",{key:1,class:"scroll-control left",onClick:a[9]||(a[9]=z=>dt("left"))},[t(X,null,{default:n(()=>[t(y(et))]),_:1})])):x("",!0),fe.value?(r(),v("button",{key:2,class:"scroll-control right",onClick:a[10]||(a[10]=z=>dt("right"))},[t(X,null,{default:n(()=>[t(y(tt))]),_:1})])):x("",!0)],2)])):x("",!0),t(ze,{modelValue:V.value,"onUpdate:modelValue":a[11]||(a[11]=z=>V.value=z),title:((Qe=S.value)==null?void 0:Qe.title)||"图片预览",width:"90%","align-center":"",class:"preview-dialog","before-close":u},{default:n(()=>[e("div",Rl,[e("div",Ol,[S.value?(r(),v("img",{key:0,src:_(S.value.image_url),alt:S.value.alt_text||S.value.title,class:"preview-image",style:qt(B.value),onWheel:Bt,onMousedown:Ft,onMousemove:Vt,onMouseup:ut,onMouseleave:ut},null,44,Nl)):x("",!0)]),e("div",ql,[t(ge,null,{default:n(()=>[t(E,{icon:y(lt),onClick:we},{default:n(()=>a[21]||(a[21]=[D("放大",-1)])),_:1,__:[21]},8,["icon"]),t(E,{icon:y(ia),onClick:Xe},{default:n(()=>a[22]||(a[22]=[D("缩小",-1)])),_:1,__:[22]},8,["icon"]),t(E,{icon:y(na),onClick:We},{default:n(()=>a[23]||(a[23]=[D("重置",-1)])),_:1,__:[23]},8,["icon"]),t(E,{icon:y(ra),onClick:Et},{default:n(()=>a[24]||(a[24]=[D("下载",-1)])),_:1,__:[24]},8,["icon"])]),_:1}),e("div",Jl,f(Math.round(ee.value*100))+"% ",1)]),Array.isArray(i.value)&&i.value.length>1?(r(),v("div",Hl,[t(E,{disabled:d.value===0,onClick:R},{default:n(()=>[t(X,null,{default:n(()=>[t(y(et))]),_:1}),a[25]||(a[25]=D(" 上一张 ",-1))]),_:1,__:[25]},8,["disabled"]),e("span",Yl,f(d.value+1)+" / "+f(Array.isArray(i.value)?i.value.length:0),1),t(E,{disabled:!Array.isArray(i.value)||d.value===i.value.length-1,onClick:Z},{default:n(()=>[a[26]||(a[26]=D(" 下一张 ",-1)),t(X,null,{default:n(()=>[t(y(tt))]),_:1})]),_:1,__:[26]},8,["disabled"])])):x("",!0)])]),_:1},8,["modelValue","title"]),A.value?(r(),te(Ys,{key:1,visible:A.value,"onUpdate:visible":a[12]||(a[12]=z=>A.value=z),"product-id":s.productId,images:i.value,onRefresh:Tt},null,8,["visible","product-id","images"])):x("",!0),t(ze,{modelValue:q.value,"onUpdate:modelValue":a[13]||(a[13]=z=>q.value=z),title:"图片集统计",width:"500px","align-center":""},{default:n(()=>[$.value?(r(),v("div",Kl,[e("div",Xl,[a[27]||(a[27]=e("span",{class:"stats-label"},"图片总数：",-1)),e("span",Ql,f($.value.total_images)+" 张",1)]),e("div",Zl,[a[28]||(a[28]=e("span",{class:"stats-label"},"总大小：",-1)),e("span",Pl,f(c($.value.total_size)),1)]),e("div",eo,[a[29]||(a[29]=e("span",{class:"stats-label"},"主图设置：",-1)),e("span",to,f($.value.has_primary?"已设置":"未设置"),1)]),e("div",ao,[a[30]||(a[30]=e("span",{class:"stats-label"},"图片类型：",-1)),e("div",so,[(r(!0),v(Me,null,De($.value.by_type,(z,se)=>(r(),v("div",{key:se,class:"type-item"},[t(je,{size:"small"},{default:n(()=>[D(f(W(se)),1)]),_:2},1024),e("span",null,f(z)+" 张",1)]))),128))])])])):x("",!0)]),_:1},8,["modelValue"]),e("input",{ref_key:"fileInput",ref:ce,type:"file",accept:"image/jpeg,image/jpg,image/png,image/webp",multiple:"",onChange:Ve,style:{display:"none"}},null,544)],2)}}}),Io=Oe(lo,[["__scopeId","data-v-5ca2bff5"]]);export{Ta as F,Io as P};
