var G=Object.defineProperty,Ae=Object.defineProperties;var Fe=Object.getOwnPropertyDescriptors;var H=Object.getOwnPropertySymbols;var Ue=Object.prototype.hasOwnProperty,$e=Object.prototype.propertyIsEnumerable;var X=(_,p,d)=>p in _?G(_,p,{enumerable:!0,configurable:!0,writable:!0,value:d}):_[p]=d,J=(_,p)=>{for(var d in p||(p={}))Ue.call(p,d)&&X(_,d,p[d]);if(H)for(var d of H(p))$e.call(p,d)&&X(_,d,p[d]);return _},K=(_,p)=>Ae(_,Fe(p)),s=(_,p)=>G(_,"name",{value:p,configurable:!0});var z=(_,p,d)=>new Promise((x,k)=>{var w=g=>{try{E(d.next(g))}catch(Q){k(Q)}},D=g=>{try{E(d.throw(g))}catch(Q){k(Q)}},E=g=>g.done?x(g.value):Promise.resolve(g.value).then(w,D);E((d=d.apply(_,p)).next())});import{u as Be,s as y,_ as Ie}from"./index-CoBZUWE1.js";/* empty css                 *//* empty css                      *//* empty css                  *//* empty css                     *//* empty css                 *//* empty css                        *//* empty css                    */import"./el-tooltip-l0sNRNKZ.js";/* empty css                        *//* empty css                         *//* empty css                 *//* empty css                *//* empty css                        *//* empty css                       *//* empty css               */import{x as Ne,r as S,c as Y,X as Z,j as je,y as ee,A as c,Q as t,H as M,K as A,I as o,al as te,M as h,u as ae,L as Oe,O as b,J as Re,D as Le,aC as We,z as T}from"./vendor-vue-XfLkFKXI.js";import{u as oe}from"./quotes-BbFL_Tm9.js";import{O as He,ak as Xe,d as Ge,b as Je,V as Ke,M as Ye,N as Ze,W as et,A as tt,X as at,Y as ot,a$ as nt,Z as lt,T as st,S as rt,j as it,b0 as ut,p as dt,q as ct,r as pt,R as mt,a0 as _t,ae as ne}from"./vendor-ui-CE-ZhXxH.js";import{c as ft,u as gt}from"./unifiedChinesePDFGenerator-C7HpLm4O.js";import"./vendor-pdf-BeW0Xq92.js";import"./vendor-utils-B8vW8fJV.js";import"./settings-Dj-ToOIB.js";const vt={class:"quotes"},yt={class:"page-header"},ht={class:"header-actions"},bt={class:"result-count"},wt={class:"customer-info"},Ct={class:"customer-details"},xt={key:0,class:"company"},Dt={class:"email"},kt={class:"amount"},Vt={class:"date-info"},St={class:"created-by"},Tt={class:"validity-info"},Et={class:"action-buttons"},Qt={class:"pagination-wrapper"},qt=Ne({__name:"Quotes",setup(_){const p=We(),d=Be(),x=S([]),k=S(!1),w=S(0),D=S(1),E=S(20),g=S(""),Q=S(null),F=S(),U=Y(()=>{var a;return(a=d.user)==null?void 0:a.id}),i=Z({search:"",status:"",min_amount:null,max_amount:null,date_from:"",date_to:"",created_by:null,page:1,per_page:20}),C=Z({field:"created_at",order:"desc"}),I=Y(()=>!!(i.search||i.status||i.min_amount||i.max_amount||i.date_from||i.date_to||i.created_by)),le=s(a=>({draft:"info",pending:"warning",approved:"success",rejected:"danger",expired:"warning"})[a]||"info","getStatusType"),N=s(a=>({draft:"草稿",pending:"待审批",approved:"已审批",rejected:"已拒绝",expired:"已过期"})[a]||a.charAt(0).toUpperCase()+a.slice(1),"formatStatus"),j=s(a=>a?new Date(a).toLocaleDateString("zh-CN",{month:"short",day:"numeric",year:"numeric"}):"无","formatDate"),se=s(a=>{if(!a)return"unknown";const e=new Date(a),l=new Date,r=e.getTime()-l.getTime(),u=Math.ceil(r/(1e3*60*60*24));return u<0?"expired":u<=7?"expiring":"valid"},"getValidityStatus"),re=s(a=>{if(!a)return"No expiry";const e=new Date(a),l=new Date,r=e.getTime()-l.getTime(),u=Math.ceil(r/(1e3*60*60*24));return u<0?"Expired":u===0?"Today":u<=7?"".concat(u,"d left"):"Valid"},"getValidityText"),ie=s(a=>a.created_by===U.value||d.isAdmin,"canEditQuote"),ue=s(a=>a.created_by===U.value||d.isAdmin,"canDeleteQuote"),de=s(a=>a.items&&Array.isArray(a.items)?a.items.length:a.product_id||a.product?1:0,"getItemCount"),ce=s(a=>typeof a!="number"||isNaN(a)?"0.00":a.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}),"formatCurrency"),pe=s(a=>{var e;return((e=a.created_by_user)==null?void 0:e.name)||"Unknown User"},"getUserName"),me=s(()=>{F.value&&clearTimeout(F.value),F.value=setTimeout(()=>{i.search=g.value,D.value=1,m()},300)},"handleSearch"),_e=s(()=>{g.value="",i.search="",m()},"handleSearchClear"),fe=s(a=>{a?(i.date_from=a[0].toISOString().split("T")[0],i.date_to=a[1].toISOString().split("T")[0]):(i.date_from="",i.date_to=""),m()},"handleDateRangeChange"),O=s(()=>{g.value="",Q.value=null,Object.assign(i,{search:"",status:"",min_amount:null,max_amount:null,date_from:"",date_to:"",created_by:null}),D.value=1,m()},"resetFilters"),ge=s(()=>{C.order=C.order==="asc"?"desc":"asc",m()},"toggleSortOrder"),ve=s(({prop:a,order:e})=>{a&&e&&(C.field=a,C.order=e==="ascending"?"asc":"desc",m())},"handleSortChange"),m=s(()=>z(this,null,function*(){var a;k.value=!0;try{const e=K(J({},i),{page:D.value,per_page:E.value,sort_by:C.field,sort_order:C.order}),l=yield oe.getAllQuotes(e);l&&l.quotes&&Array.isArray(l.quotes)?(x.value=l.quotes,l.pagination&&typeof l.pagination.total!="undefined"?w.value=l.pagination.total:typeof l.total!="undefined"?w.value=l.total:w.value=l.quotes.length):l&&Array.isArray(l)?(x.value=l,w.value=l.length):(x.value=[],w.value=0,y.warning("无法加载报价数据，请检查服务器连接"))}catch(e){if(x.value=[],w.value=0,e.response){const l=e.response.status,r=((a=e.response.data)==null?void 0:a.message)||e.message;l===404?y.error("Quotes endpoint not found. Please check API configuration."):l>=500?y.error("Server error. Please try again later."):y.error("Failed to load quotes: ".concat(r))}else e.request?y.error("Network error. Please check your connection."):y.error("Failed to load quotes")}finally{k.value=!1}}),"loadQuotes"),ye=s(a=>{D.value=a,m()},"handlePageChange"),he=s(a=>{E.value=a,D.value=1,m()},"handlePageSizeChange"),be=s(a=>{p.push("/quotes/".concat(a.id,"/edit"))},"editQuote"),we=s(l=>z(this,[l],function*({action:a,quote:e}){switch(a){case"duplicate":yield Ce();break;case"pdf":yield xe(e);break;case"delete":yield De(e);break}}),"handleQuoteAction"),Ce=s(a=>z(this,null,function*(){try{yield ne.confirm("This will create a new quote with the same items and customer information. Continue?","Duplicate Quote",{confirmButtonText:"Create Duplicate",cancelButtonText:"Cancel",type:"info"}),y.info("Duplicate functionality will be implemented in the next phase")}catch(e){}}),"duplicateQuote"),xe=s(a=>z(this,null,function*(){try{const e=yield ft(a);yield gt.downloadPDF(e,"报价单-".concat(a.quote_number)),y.success("PDF导出成功")}catch(e){y.error("PDF导出失败")}}),"exportQuotePDF"),De=s(a=>z(this,null,function*(){var e,l;try{const u={approved:"此报价已通过审批，删除后将无法恢复。",pending:"此报价正在等待审批，删除后将无法恢复。",rejected:"此报价已被拒绝，确认删除？",expired:"此报价已过期，确认删除？",draft:"确认删除此草稿报价？"}[a.status]||"确认删除此报价？",q=N(a.status);yield ne.confirm("".concat(u,"\n\n报价单号: ").concat(a.quote_number,"\n状态: ").concat(q,"\n\n此操作不可撤销，请谨慎操作。"),"删除报价确认",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",dangerouslyUseHTMLString:!1});const P=(yield oe.deleteQuote(a.id)).message||"报价删除成功";y.success(P),m()}catch(r){if(r==="cancel")return;let u="删除报价失败";if(r.response){const q=r.response.status,f=((e=r.response.data)==null?void 0:e.error)||((l=r.response.data)==null?void 0:l.message);switch(q){case 403:u="权限不足："+(f||"您没有权限删除这个报价");break;case 404:u="报价不存在或已被删除";break;case 500:u="服务器错误："+(f||"请稍后重试");break;default:u=f||"删除失败 (错误代码: ".concat(q,")")}}else r.request?u="网络连接错误，请检查网络后重试":u=r.message||"未知错误";y.error(u)}}),"deleteQuote"),ke=s(()=>{y.info("Bulk export functionality will be implemented in the next phase")},"exportQuotes");return je(()=>{m()}),(a,e)=>{const l=Je,r=Ge,u=te("router-link"),q=et,f=Ze,P=Ye,v=ot,$=at,Ve=nt,R=lt,L=He,V=rt,Se=it,Te=te("Menu"),Ee=ut,B=pt,Qe=ct,qe=dt,ze=mt,Me=_t,W=Xe,Pe=st;return T(),ee("div",vt,[c("div",yt,[e[9]||(e[9]=c("h1",null,"报价管理",-1)),c("div",ht,[t(u,{to:"/quotes/create"},{default:o(()=>[t(r,{type:"primary",size:"large"},{default:o(()=>[t(l,null,{default:o(()=>[t(ae(Ke))]),_:1}),e[8]||(e[8]=h(" 创建报价 ",-1))]),_:1,__:[8]})]),_:1})])]),t(L,{class:"filter-card"},{default:o(()=>[t(P,{gutter:20,class:"search-row"},{default:o(()=>[t(f,{span:24},{default:o(()=>[t(q,{modelValue:g.value,"onUpdate:modelValue":e[0]||(e[0]=n=>g.value=n),placeholder:"按报价单号、客户姓名、公司或邮箱搜索...",clearable:"",size:"large",onInput:me,onClear:_e},{prefix:o(()=>[t(l,null,{default:o(()=>[t(ae(tt))]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),t(P,{gutter:20,class:"filter-row"},{default:o(()=>[t(f,{span:4},{default:o(()=>[t($,{modelValue:i.status,"onUpdate:modelValue":e[1]||(e[1]=n=>i.status=n),placeholder:"所有状态",clearable:"",onChange:m,style:{width:"100%"}},{default:o(()=>[t(v,{label:"所有状态",value:""}),t(v,{label:"草稿",value:"draft"}),t(v,{label:"待审批",value:"pending"}),t(v,{label:"已审批",value:"approved"}),t(v,{label:"已拒绝",value:"rejected"}),t(v,{label:"已过期",value:"expired"})]),_:1},8,["modelValue"])]),_:1}),t(f,{span:5},{default:o(()=>[t(Ve,{modelValue:Q.value,"onUpdate:modelValue":e[2]||(e[2]=n=>Q.value=n),type:"daterange","start-placeholder":"开始日期","end-placeholder":"结束日期",onChange:fe,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),t(f,{span:4},{default:o(()=>[t(R,{modelValue:i.min_amount,"onUpdate:modelValue":e[3]||(e[3]=n=>i.min_amount=n),placeholder:"最小金额",min:0,precision:2,onChange:m,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),t(f,{span:4},{default:o(()=>[t(R,{modelValue:i.max_amount,"onUpdate:modelValue":e[4]||(e[4]=n=>i.max_amount=n),placeholder:"最大金额",min:0,precision:2,onChange:m,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),t(f,{span:4},{default:o(()=>[t($,{modelValue:i.created_by,"onUpdate:modelValue":e[5]||(e[5]=n=>i.created_by=n),placeholder:"创建者",clearable:"",onChange:m,style:{width:"100%"}},{default:o(()=>[t(v,{label:"所有用户",value:""}),t(v,{label:"我的报价",value:U.value},null,8,["value"])]),_:1},8,["modelValue"])]),_:1}),t(f,{span:3},{default:o(()=>[t($,{modelValue:C.field,"onUpdate:modelValue":e[6]||(e[6]=n=>C.field=n),placeholder:"排序方式",onChange:m,style:{width:"100%"}},{default:o(()=>[t(v,{label:"创建日期",value:"created_at"}),t(v,{label:"金额",value:"total_price"}),t(v,{label:"客户",value:"customer_name"}),t(v,{label:"报价单号",value:"quote_number"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),t(P,{gutter:20,class:"action-row"},{default:o(()=>[t(f,{span:12},{default:o(()=>[t(r,{onClick:O,icon:"Refresh"},{default:o(()=>e[10]||(e[10]=[h("重置筛选",-1)])),_:1,__:[10]}),t(r,{onClick:ge,link:""},{default:o(()=>[t(l,null,{default:o(()=>[(T(),M(Oe(C.order==="asc"?"SortUp":"SortDown")))]),_:1}),h(" "+b(C.order==="asc"?"升序":"降序"),1)]),_:1})]),_:1}),t(f,{span:12,class:"text-right"},{default:o(()=>[c("span",bt,"找到 "+b(w.value)+" 个报价",1),t(r,{onClick:ke,link:"",icon:"Download"},{default:o(()=>e[11]||(e[11]=[h("导出",-1)])),_:1,__:[11]})]),_:1})]),_:1})]),_:1}),t(L,null,{default:o(()=>[Re((T(),M(ze,{data:x.value,style:{width:"100%"},onSortChange:ve,stripe:""},{default:o(()=>[t(V,{prop:"quote_number",label:"报价单号",width:"140",sortable:"custom"},{default:o(({row:n})=>[t(u,{to:"/quotes/".concat(n.id),class:"quote-link"},{default:o(()=>[c("strong",null,b(n.quote_number),1)]),_:2},1032,["to"])]),_:1}),t(V,{label:"客户","min-width":"200",sortable:"custom",prop:"customer_name"},{default:o(({row:n})=>[c("div",wt,[c("strong",null,b(n.customer_name),1),c("div",Ct,[n.customer_company?(T(),ee("div",xt,b(n.customer_company),1)):A("",!0),c("div",Dt,b(n.customer_email),1)])])]),_:1}),t(V,{prop:"status",label:"状态",width:"130",sortable:"custom"},{default:o(({row:n})=>[t(Se,{type:le(n.status),size:"large"},{default:o(()=>[h(b(N(n.status)),1)]),_:2},1032,["type"])]),_:1}),t(V,{label:"项目",width:"80",align:"center"},{default:o(({row:n})=>[t(Ee,{value:de(n),type:"primary"},{default:o(()=>[t(l,null,{default:o(()=>[t(Te)]),_:1})]),_:2},1032,["value"])]),_:1}),t(V,{prop:"total_price",label:"金额",width:"140",sortable:"custom",align:"right"},{default:o(({row:n})=>[c("span",kt," $"+b(ce(n.total_price)),1)]),_:1}),t(V,{prop:"created_at",label:"创建时间",width:"120",sortable:"custom"},{default:o(({row:n})=>[c("div",Vt,[c("div",null,b(j(n.created_at)),1),c("div",St,b(pe(n)),1)])]),_:1}),t(V,{label:"有效期",width:"120"},{default:o(({row:n})=>[c("div",Tt,[c("div",null,b(j(n.valid_until)),1),c("div",{class:Le(["validity-status",se(n.valid_until)])},b(re(n.valid_until)),3)])]),_:1}),t(V,{label:"操作",width:"180",fixed:"right"},{default:o(({row:n})=>[c("div",Et,[t(u,{to:"/quotes/".concat(n.id)},{default:o(()=>[t(r,{size:"small",type:"primary",link:"",icon:"View"},{default:o(()=>e[12]||(e[12]=[h("查看",-1)])),_:1,__:[12]})]),_:2},1032,["to"]),n.status==="draft"&&ie(n)?(T(),M(r,{key:0,size:"small",type:"primary",onClick:s(zt=>be(n),"onClick"),icon:"Edit"},{default:o(()=>e[13]||(e[13]=[h(" 编辑 ",-1)])),_:2,__:[13]},1032,["onClick"])):A("",!0),t(qe,{trigger:"click",onCommand:we},{dropdown:o(()=>[t(Qe,null,{default:o(()=>[t(B,{command:{action:"duplicate",quote:n},icon:"DocumentCopy"},{default:o(()=>e[14]||(e[14]=[h(" 复制 ",-1)])),_:2,__:[14]},1032,["command"]),t(B,{command:{action:"pdf",quote:n},icon:"Download"},{default:o(()=>e[15]||(e[15]=[h(" 导出PDF ",-1)])),_:2,__:[15]},1032,["command"]),ue(n)?(T(),M(B,{key:0,command:{action:"delete",quote:n},icon:"Delete",divided:""},{default:o(()=>e[16]||(e[16]=[h(" 删除 ",-1)])),_:2,__:[16]},1032,["command"])):A("",!0)]),_:2},1024)]),default:o(()=>[t(r,{size:"small",type:"info",icon:"MoreFilled"})]),_:2},1024)])]),_:1})]),_:1},8,["data"])),[[Pe,k.value]]),c("div",Qt,[t(Me,{"current-page":D.value,"onUpdate:currentPage":e[7]||(e[7]=n=>D.value=n),"page-size":E.value,total:w.value,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:ye,onSizeChange:he},null,8,["current-page","page-size","total"])])]),_:1}),!k.value&&x.value.length===0&&!I.value?(T(),M(W,{key:0,description:"还没有创建报价单","image-size":200},{default:o(()=>e[17]||(e[17]=[c("p",null,"创建您的第一个报价单开始使用",-1)])),extra:o(()=>[t(u,{to:"/quotes/create"},{default:o(()=>[t(r,{type:"primary"},{default:o(()=>e[18]||(e[18]=[h("创建报价",-1)])),_:1,__:[18]})]),_:1})]),_:1})):A("",!0),!k.value&&x.value.length===0&&I.value?(T(),M(W,{key:1,description:"没有找到符合条件的报价单","image-size":160},{extra:o(()=>[t(r,{onClick:O},{default:o(()=>e[19]||(e[19]=[h("清除筛选",-1)])),_:1,__:[19]})]),_:1})):A("",!0)])}}}),oa=Ie(qt,[["__scopeId","data-v-fbe3e52d"]]);export{oa as default};
